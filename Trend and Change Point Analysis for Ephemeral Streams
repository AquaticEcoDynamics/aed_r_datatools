library(scales)
library(plotrix)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggpubr)
library(tibble)
library(rlang)
library(gridExtra)
library(egg)
library(grid)
library(readxl)
library(hrbrthemes)
library(viridis)
library(readr)
library(trend)
library(tidyverse)
library(boot)
library(data.table)
library(HKprocess)
library(formattable)
####################
library(hydrostats)
library(plyr)
library(fasstr)
library(FlowScreen)
library(hydroTSM)
library(lfstat)
library(openxlsx)
library(xts)
library(rkt)
####
library(DT)
library(rkt)
library(ecp)
library(lubridate)
library(htmltools)
#####################
########################## Seasonal MK trend test for Flow
setwd("C:/Users/........")

flow <- read_excel("605012.xlsx")

#flow$date<- as.Date(with(flow, paste(flow$Y,flow$m, flow$d,sep="-")), "%Y-%m-%d")
str(flow)
Flow<- flow %>% dplyr::select(3,6)
str(Flow)
summary(Flow)
Flow<- na.omit(Flow) 
Area<-73202229.3995#*(10^6)
#Area<-(Area)/(10^9)
str(Area)
Flow$`Discharge (m³/s) MEAN` <- (as.numeric(Flow$`Discharge (m³/s) MEAN`)*86400*1000)/(Area)

colnames(Flow)<- c("date","Q")
#Flow$date<-as.Date(Flow$date)
Flow$Q<-as.numeric(Flow$Q)
Flow$Q_GL <- (Flow$Q*86400)/1000000
Flow<-Flow%>% dplyr::select(1,3)
Flow <-Flow[ order(Flow$date , decreasing = FALSE ),]
#Flow <- Flow[rev(order(as.Date(Flow$date))),]
#Flow[rev(order(as.Date(Flow$date, format = "%d-%m-%Y"))),]
# difination of ephemeral streams if ZFD >= 90 zero days/365 days=0.25
Zero_flow_day<- Flow[Flow[,2] <=0 ,2]
ZFD<-length(Zero_flow_day$Q_GL)/length(Flow$date)
Ephe_Pere<- if (ZFD>0.25){print("ephemeral")} else{print("perennial")}
Ephe_Pere
capture.output(summary(print(Ephe_Pere)), file = " ephemeral or perennial.txt")
###############################
Start_end_ZFD<- with(rle(Flow$Q_GL), {
  ok <- values == 0 & lengths > 30
  ends <- cumsum(lengths)
  starts <- ends - lengths + 1
  data.frame(starts, ends)[ok, ]
})
########## identify the date of zero day
DT <- data.table(Flow)
# add the original order, so you can't lose it
DT[, orig := .I]
# rle by id, saving the length as a new variables
DT[, rleLength := {rr <- rle(Q_GL); rep(rr$length, rr$length)}, by = 'orig']
# key by Q_GLand length to subset 
setkey(DT, Q_GL, rleLength)
# which rows are Q_GL = 0 and length > 2
Zero_timeseries<- DT[list(0, unique(rleLength[rleLength>30])),nomatch=0]
#################
ts_Flow <- xts(Zero_timeseries$Q_GL, as.Date(Zero_timeseries$date, "%Y-%m-%d"))
ts_zero_flow=data.frame(sum_flow=coredata(ts_Flow),date=index(ts_Flow))
Flow_Zero_Ts= ts_zero_flow%>% 
  mutate(date = ymd(date)) %>% 
  mutate_at(vars(date), funs(year, month, day))
colnames(Flow_Zero_Ts) <- c("Zero_flow","date","Year","Month","Day")

Zero<-plyr::ddply(Flow_Zero_Ts, plyr::.(Year), function(m){
  m$number<- if(m$Zero_flow==0){as.numeric (1)} else{as.numeric(0)}
  
  return(m)
}
)
##################
ZZZFDDD<- xts(Zero$number, as.Date(Zero$date, "%Y-%m-%d"))
str(ZZZFDDD)
# convert daily data to annual and monthly
ts_m_zeroflow = apply.monthly(ZZZFDDD, sum)
ts_y_zeroflow = apply.yearly(ZZZFDDD, sum)
#################
Zero_Flow_Monthly=data.frame(sum_zeroflow=coredata(ts_m_zeroflow),date=index(ts_m_zeroflow))
Zero_Flow_Yearly=data.frame(sum_zeroflow=coredata(ts_y_zeroflow),date=index(ts_y_zeroflow))
Zero_Flow_Monthly = Zero_Flow_Monthly %>% 
  mutate(date = ymd(date)) %>% 
  mutate_at(vars(date), funs(year, month, day))
Zero_Flow_Yearly = Zero_Flow_Yearly %>% 
  mutate(date = ymd(date)) %>% 
  mutate_at(vars(date), funs(year, month, day))
colnames(Zero_Flow_Monthly) <- c("sum_zeroflow","date","Year","Month","Day")
colnames(Zero_Flow_Yearly) <- c("sum_zeroflow","date","Year","Month","Day")
#############################
############## SMK TEST for Zero FLOW Days
Tr_zeroflow<-rkt(Zero_Flow_Monthly$Year,Zero_Flow_Monthly$sum_zeroflow,Zero_Flow_Monthly$Month,,TRUE)
print(Tr_zeroflow)
capture.output(summary(print(Tr_zeroflow)), file = " Zero Flow SMK test results.txt")
########### OMK test ero FLOW Days
Zero_Flow_Yearly$yearfraction<-(Zero_Flow_Yearly$Year+0.110)
TR_annual_zeroflow<-rkt(Zero_Flow_Yearly$yearfraction,Zero_Flow_Yearly$sum_zeroflow)
print(TR_annual_zeroflow)
##############################

#####################
zeroflow_TS<-ts(Zero_Flow_Monthly[, 1], start = c(Zero_Flow_Monthly$Year[1], Zero_Flow_Monthly$Month[1]),end=c(Zero_Flow_Monthly$Year[length(Zero_Flow_Monthly$Year)],Zero_Flow_Monthly$Month[length(Zero_Flow_Monthly$Month)]), frequency = 12)
#########Change point detection using Lanzanteâs test
tiff(paste0("zeroflow_TS_monthly_lanzante_test ",".tiff"),width=1500, height=1000, res = 300)
plot(Zero_Flow_Monthly$sum_zeroflow)
s.res <- lanzante.test(Zero_Flow_Monthly$sum_zeroflow)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean(Zero_Flow_Monthly$sum_zeroflow[1:i])
s.2 <- mean(Zero_Flow_Monthly$sum_zeroflow[(i+1):n])
s <- ts(c(rep(s.1,i), rep(s.2,(n-i))))
tsp(s) <- tsp(Zero_Flow_Monthly$sum_zeroflow)
lines(s, col=2,lty=1)
print(s.res)
dev.off()
###################################
################################# ECP
#### ENERGY AGGLOMERATIVE
###x and X1 should be mattrix
Zero_Flow_Yearly
ZeroFlow1<-Zero_Flow_Yearly%>% dplyr::select(1)
ZeroFlow1<- as.matrix(ZeroFlow1)
x1= rep(c(min(Zero_Flow_Yearly$Year):max(Zero_Flow_Yearly$Year)), times= c(1))
########################
n=length(Zero_Flow_Yearly$date)
num=1
mem <- vector()

while (n>11) {
  
  x= rep(c(num), times= c(11))
  
  n=n-11
  
  num=num+1
  
  mem <- append(mem, x)
  
}

x= rep(c(num), times= c(n))

mem <- append(mem, x)

print(mem)
#### mem= c=shows possible number of change point and time should the same as x=Flow1 length
tiff(paste0("Zeroflow_annual_ECP test",".tiff"),width=1500, height=1000, res = 300)
CP_ZeroFlow = e.agglo(X=ZeroFlow1,member=mem,alpha=2,penalty=function(cp,Xts) 0)
CP_ZeroFlow$estimates
CP_ZeroFlow$cluster
#plot(CP_ZeroFlow$cluster)
plot(x1, CP_ZeroFlow$cluster,
     main="ECP test Zeroflow annual",
     xlab = "Year",
     ylab="cluster",
     type="p",
     col="blue")
dev.off()
#####################################
##################################### OMK test for ANNUAL FLOW
Zero_Flow_Yearly<- Zero_Flow_Yearly
TR_annual_zeroflow<-rkt(Zero_Flow_Yearly$yearfraction,Zero_Flow_Yearly$sum_zeroflow)
print(TR_annual_zeroflow)
capture.output(summary(print(TR_annual_zeroflow)), file = " Zro Flow_annual MK test results.txt")
TR_annual_zeroflow$sl
TR_annual_zeroflow$B
b0<- median(Zero_Flow_Yearly$sum_zeroflow)-(TR_annual_zeroflow$B * median(Zero_Flow_Yearly$Year))
Zero_Flow_Yearly$overall_slope<- b0+(TR_annual_zeroflow$B * Zero_Flow_Yearly$Year)
a1<-as.character(Zero_Flow_Yearly$Year[1]) 
b1<-as.character(Zero_Flow_Yearly$Year[length(Zero_Flow_Yearly$Year)]) 
z1<-as.character(lapply(TR_annual_zeroflow$B, round,2))
Zero_Flow_Yearly$`Sens Slope`<- paste("a)",a1,"-",b1,":"," ",z1," ","day/yr",sep='')
######################################
###################################### MKLTP tEST FOR ANNUALL Flow
Zero_Flow_Yearly$MKLTP.Sig<-as.numeric (NA)
Zero_Flow_Yearly$Mean<-as.numeric (NA)
Zero_Flow_Yearly$Line<-as.numeric (NA)
Zero_Flow_Yearly$overll_line<-as.numeric (Zero_Flow_Yearly$overall_slope)
Zero_Flow_Yearly$Line.pvalue<-as.character(NA)
Zero_Flow_Yearly$Mid_date<-as.Date.numeric(NA)
Zero_Flow_Yearly$mLine<- as.numeric(NA)
######################################
Zero_Flow_Yearly$Max_date<- as.Date.numeric(NA) 
Zero_Flow_Yearly$ECP<-as.character(NA) 
Zero_Flow_Yearly$Seq_p.value<-as.numeric (NA)
Zero_Flow_Yearly$MKLTP_p.value<-as.numeric (NA)
#######################################
#######################################
myts_Annuall<- ts(Zero_Flow_Yearly$sum_zeroflow, start=c(min(Zero_Flow_Yearly$Year)), end=c(max(Zero_Flow_Yearly$Year)), frequency=1)
MKLTP_Annuall_Flow<- MannKendallLTP(myts_Annuall)
capture.output(summary(print(MKLTP_Annuall_Flow)), file = " MKLTP annual flow.txt")
Zero_Flow_Yearly$MKLTP.Sig<- if (MKLTP_Annuall_Flow$Mann_Kendall_LTP[2]>0.01){
  paste(lapply(MKLTP_Annuall_Flow$Mann_Kendall_LTP[2], round,2))} else {0.001}
Zero_Flow_Yearly$Line.pvalue<-if (Zero_Flow_Yearly$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",Zero_Flow_Yearly$MKLTP.Sig,")", sep = "")} else{NA}
Zero_Flow_Yearly$Mid_date<-min(Zero_Flow_Yearly$date)
##view(Zero_Flow_Yearly)
############################
Zero_Flow_Yearly$Seq<-as.numeric(CP_ZeroFlow$cluster) 
max(Zero_Flow_Yearly$Seq)
max(length(Zero_Flow_Yearly$Seq))
ddddddddd<-as.numeric( which(CP_ZeroFlow$cluster == max(CP_ZeroFlow$cluster)))
Zero_Flow_Yearly$Seq[max(ddddddddd)+1]
jj<-max(ddddddddd)
JJJ<-as.numeric( length(Zero_Flow_Yearly$Seq))
Zero_Flow_Yearly$Seq[max(ddddddddd)+1]
i=Zero_Flow_Yearly$Seq[max(ddddddddd)+1]
Zero_Flow_Yearly$Seq[jj:JJJ]<- 
  if(i < as.numeric(Zero_Flow_Yearly$Seq[max(ddddddddd)])) {as.numeric(max(CP_ZeroFlow$cluster)+1)} else{Zero_Flow_Yearly$Seq}

################# SUBSET THE DATA BASED ON ecp

#for (i in Zero_Flow_Yearly$Seq){  
# m<- assign(paste("segment_", i, sep = "_"),subset(Zero_Flow_Yearly, Seq==i))}

######################################
##view(Zero_Flow_Yearly)
Max_Seq_annuall<-max(Zero_Flow_Yearly$Seq)
NNNNN<-plyr::ddply(Zero_Flow_Yearly, plyr::.(Seq), function(m){
  FD<-rkt(m$yearfraction,m$sum_zeroflow)
  capture.output(summary(print(FD)), file = " zeroFlow_Annuall MK test results for segments.txt")
  b0<- median(m$sum_zeroflow)-(FD$B* median(m$Year))
  m$overall_slope<- b0+(FD$B*m$Year)
  a3<-as.character(m$Year[1]) 
  b3<-as.character(m$Year[length(m$Year)]) 
  z3<-as.character(lapply(FD$B, round,2))
  m$`Sens Slope`<- paste( (if (m$Seq==1){"b)"} else if (m$Seq==2){"c)"} else if (m$Seq==3){"d)"} else if (m$Seq==4){"e)"} else if  (m$Seq==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","day/yr",sep='')
  m$Max_date<- if (m$Seq< Max_Seq_annuall){as.Date(max(m$date))} else {as.Date.numeric(NA)}
  m$ECP<- if (m$Seq< Max_Seq_annuall){paste("ECP", m$Seq, sep = "")} else {as.character (NA)}
  m$Seq_p.value<- paste(lapply(FD$sl, round,2))
  ###################################
  myts_Annuall<- ts(m$sum_zeroflow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
  MKLTP_Annuall_Flow<- MannKendallLTP(myts_Annuall)
  m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Annuall_Flow$Mann_Kendall_LTP[2], round,2),")", sep = "")
  #########################
  m$Mid_date<- min(m$date)
  m$Mean<-as.numeric (mean(m$sum_zeroflow))
  m$MKLTP.Sig<- if (MKLTP_Annuall_Flow$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Annuall_Flow$Mann_Kendall_LTP[2], round,2))} else {0.001}
  m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
  m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
  m$overll_line<-as.numeric (NA)
  m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
  ########
  return(m)
}
)
##view(NNNNN)
##################################
total_zeroflow_annuall <- rbind(Zero_Flow_Yearly,NNNNN)
##view(Zero_Flow_Yearly)
tiff(paste0(" Annual zeroflow_trend_change point ",".tiff"),width=2000, height=1500, res = 350)
annual_zeroflowtrend1<-ggplot(total_zeroflow_annuall, aes(x=date, color=`Sens Slope`))+
  geom_point(aes( y=sum_zeroflow),size=1)+
  ggtitle("Annuall Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+
  xlab("Date")+ylab("Zero Flow (day/yr)")

annual_zeroflowtrend2<-annual_zeroflowtrend1+geom_line(aes(y=overll_line),size=0.8,
                                                       linetype= if(total_zeroflow_annuall$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )

annual_zeroflowtrend2<-annual_zeroflowtrend2+geom_line(aes(y=Line),size=0.8,linetype="twodash")

annual_zeroflowtrend3<-annual_zeroflowtrend2+geom_line(aes(y=mLine),size=0.8,
                                                       linetype= if(total_zeroflow_annuall$MKLTP.Sig<= 0.05){"twodash"} else {"solid"})
################################
for (i in total_zeroflow_annuall$Max_date){
  annual_zeroflowtrend3  <- annual_zeroflowtrend3+ 
    geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
}

annual_zeroflowtrend4<-annual_zeroflowtrend3+geom_text(mapping = aes(x = Max_date,
                                                                     y = max(sum_zeroflow),
                                                                     label = ECP,
                                                                     hjust = 1.5,
                                                                     vjust = 1.5),
                                                       size=3,
                                                       angle=90,
                                                       show.legend = FALSE,
                                                       data = total_zeroflow_annuall)

annual_zeroflowtrend4<- annual_zeroflowtrend4+geom_text(mapping = aes(x = Mid_date,
                                                                      y = max(sum_zeroflow),
                                                                      fill=`Sens Slope`,
                                                                      label = Line.pvalue,
                                                                      hjust =1,
                                                                      vjust = 5.5),
                                                        size=2.5,
                                                        angle=90,
                                                        show.legend = FALSE,
                                                        data = total_zeroflow_annuall)
annual_zeroflowtrend4
dev.off()
###############################
ZeroFlow1
for(i in 1:5){
  ED_Annuall_Zero=e.divisive(X=ZeroFlow1,sig.lvl=0.05,R=199,k=NULL,min.size=10,alpha=1)
  if(ED_Annuall_Zero$p.values[1]<=0.05) {
    print("End of Loop") ;
    break
  } else{print("KHHHH")}
  
}
#view(Flow_yearly)
#######################
if (max(ED_Annuall_Zero$cluster)<2){capture.output(print("No change point"), file = " EDP No Change point for annuall zero flow.txt")} else{
  Zeroflow_ED<-Zero_Flow_Yearly %>% dplyr::select(1:8)
  Zeroflow_ED$Seq_ED<-as.numeric(ED_Annuall_Zero$cluster)
  ####################
  #################### MKLTP
  Zeroflow_ED$MKLTP.Sig<-as.numeric (NA)
  Zeroflow_ED$Mean<-as.numeric (NA)
  Zeroflow_ED$Line<-as.numeric (NA)
  Zeroflow_ED$overll_line<-as.numeric (Zeroflow_ED$overall_slope)
  Zeroflow_ED$Line.pvalue<-as.character(NA)
  Zeroflow_ED$mLine<- as.numeric(NA)
  #####################################
  Zeroflow_ED$Max_date_ED<- as.Date.numeric(NA) 
  Zeroflow_ED$EDP<-as.character(NA) 
  Zeroflow_ED$p.value<-as.numeric (NA)
  Zeroflow_ED$Seq_p.value<-as.numeric (NA)
  Zeroflow_ED$MKLTP_p.value<-as.numeric (NA)
  Zeroflow_ED$Mid_date_ED<-as.Date.numeric(NA)
  #####################################
  
  myts_Annuall_ED<- ts(Zeroflow_ED$sum_zeroflow, start=c(min(Zeroflow_ED$Year)), end=c(max(Zeroflow_ED$Year)), frequency=1)
  MKLTP_Annuall_Zeroflow_ED<- MannKendallLTP(myts_Annuall_ED)
  capture.output(summary(print(MKLTP_Annuall_Zeroflow_ED)), file = " MKLTP annual Zeroflow_ED.txt")
  Zeroflow_ED$MKLTP.Sig<- if (MKLTP_Annuall_Zeroflow_ED$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Annuall_Zeroflow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
  Zeroflow_ED$Line.pvalue<-if (Zeroflow_ED$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",Zeroflow_ED$MKLTP.Sig,")", sep = "")} else{NA}
  Zeroflow_ED$Mid_date_ED<-min(Zeroflow_ED$date)
  ####
  ddddddddd<-as.numeric( which(ED_Annuall_Zero$cluster == max(ED_Annuall_Zero$cluster)))
  max(ddddddddd)
  str(ddddddddd)
  Zeroflow_ED$Seq_ED[max(ddddddddd)+1]
  jj<-max(ddddddddd)
  JJJ<-as.numeric( length(Zeroflow_ED$Seq_ED))
  Zeroflow_ED$Seq_ED[max(ddddddddd)+1]
  i=Zeroflow_ED$Seq_ED[max(ddddddddd)+1]
  #################
  
  #for (i inZeroflow_ED$Seq){  
  # m<- assign(paste("segment_", i, sep = "_"),subset(Zeroflow_ED, Seq==i))}
  
  ######################################
  Max_Seq_ED_Annuall_Zero<-max(Zeroflow_ED$Seq_ED)
  EDPP<-plyr::ddply(Zeroflow_ED, plyr::.(Seq_ED), function(m){
    FD<-rkt(m$yearfraction,m$sum_zeroflow)
    FD$B
    b0<- median(m$sum_zeroflow)-(FD$B* median(m$Year))
    m$overall_slope<- b0+(FD$B*m$Year)
    length(m$Year)
    a3<-as.character(m$Year[1]) 
    b3<-as.character(m$Year[length(m$Year)]) 
    z3<-as.character(lapply(FD$B, round,2))
    m$`Sens Slope`<- paste( (if (m$Seq_ED==1){"b)"} else if (m$Seq_ED==2){"c)"} else if (m$Seq_ED==3){"d)"} else if (m$Seq_ED==4){"e)"} else if  (m$Seq_ED==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","day/yr",sep='')
    m$Max_date_ED<- if (m$Seq_ED< Max_Seq_ED_Annuall_Zero){as.Date(max(m$date))} else {as.Date.numeric(NA)}
    m$p.value<- ED_Annuall_Zero$p.values[m$Seq_ED]
    m$EDP<- if (m$Seq_ED< Max_Seq_ED_Annuall_Zero){paste("EDP", m$Seq_ED," ","p","(",m$p.value,")", sep = "")} else {as.character (NA)}
    m$Seq_p.value<- paste(lapply(FD$sl, round,2))
    m$Mid_date_ED<- median(m$date)
    #######
    myts_ED_annual <- ts(m$sum_zeroflow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
    MKLTP_Annuall_Zeroflow_ED<- MannKendallLTP( myts_ED_annual)
    m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Annuall_Zeroflow_ED$Mann_Kendall_LTP[2], round,2),")", sep = "")
    #########################
    m$Mid_date_ED<- min(m$date)
    m$Mean<-as.numeric (mean(m$sum_zeroflow))
    m$MKLTP.Sig<- if (MKLTP_Annuall_Zeroflow_ED$Mann_Kendall_LTP[2]>0.01){
      paste(lapply(MKLTP_Annuall_Zeroflow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
    m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
    m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
    m$overll_line<-as.numeric (NA)
    m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
    #######################
    return(m)
  }
  )
  
  #####################################################################################
  total_zeroflow_annuall_EDP <- rbind(Zeroflow_ED,EDPP)
  ##view(total_zeroflow_annuall_EDP)
  tiff(paste0(" Annual zero flow_trend_EDP change point ",".tiff"),width=2000, height=1500, res = 350)
  annual_zeroflowtrend_EDP1<-ggplot( total_zeroflow_annuall_EDP, aes(x=date,color=`Sens Slope`))+
    geom_point(aes( y=sum_zeroflow),size=1) +xlab("Date")+ylab("Zero Flow (day/yr)")+
    ggtitle("Annuall Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))
  annual_zeroflowtrend_EDP2<-annual_zeroflowtrend_EDP1+geom_line(aes(y=mLine),size=0.8,
                                                                 linetype= if( total_zeroflow_annuall_EDP$MKLTP.Sig<= 0.050){"twodash"} else {"solid"})
  annual_zeroflowtrend_EDP3<-annual_zeroflowtrend_EDP2+geom_line(aes(y=Line),size=0.8,linetype="twodash")
  annual_zeroflowtrend_EDP4<-annual_zeroflowtrend_EDP3+geom_line(aes(y=overll_line),size=0.8,
                                                                 linetype= if(total_zeroflow_annuall_EDP$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )
  #########
  
  for (i in  total_zeroflow_annuall_EDP$Max_date_ED){
    annual_zeroflowtrend_EDP4  <- annual_zeroflowtrend_EDP4+ 
      geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
  }
  
  annual_zeroflowtrend_EDP4<-annual_zeroflowtrend_EDP4+geom_text(mapping = aes(x = Max_date_ED,
                                                                               y = max(sum_zeroflow),
                                                                               label = EDP,
                                                                               hjust = 1.5,
                                                                               vjust = 1.5),
                                                                 size=3,
                                                                 angle=90,
                                                                 show.legend = FALSE,
                                                                 data =total_zeroflow_annuall_EDP)
  
  annual_zeroflowtrend_EDP4<- annual_zeroflowtrend_EDP4+geom_text(mapping = aes(x = Mid_date_ED,
                                                                                y = max(sum_zeroflow),
                                                                                label = Line.pvalue,
                                                                                hjust =1,
                                                                                vjust = 5.5),
                                                                  size=2.5,
                                                                  angle=90,
                                                                  show.legend = FALSE,
                                                                  data =total_zeroflow_annuall_EDP)
  annual_zeroflowtrend_EDP4
}# end of if
dev.off()
################################
################## avarage flow based on month of each year
ts_Flow <- xts(Flow$Q_GL, as.Date(Flow$date, "%Y-%m-%d"))
# convert daily data to annual and monthly
ts_m_flow = apply.monthly(ts_Flow, sum)
ts_y_flow = apply.yearly(ts_Flow, sum)
##ts_q = apply.quarterly(ts, sum)
ts_m_f=data.frame(sum_flow=coredata(ts_m_flow),date=index(ts_m_flow))
ts_y_f=data.frame(sum_flow=coredata(ts_y_flow),date=index(ts_y_flow))
Flow_monthly = ts_m_f %>% 
  mutate(date = ymd(date)) %>% 
  mutate_at(vars(date), funs(year, month, day))
Flow_yearly = ts_y_f %>% 
  mutate(date = ymd(date)) %>% 
  mutate_at(vars(date), funs(year, month, day))
colnames(Flow_monthly) <- c("sum_flow","date","Year","Month","Day")
colnames(Flow_yearly) <- c("sum_flow","date","Year","Month","Day")
######### Making hydrological year
Flow_monthly$hyear<- ifelse(Flow_monthly$Month>=5,Flow_monthly$Year,Flow_monthly$Year-1)
###### Rainfall for partial SMK Test
Rainfall <- read_excel("Rainfall.xlsx")
############## SMK TEST FLOW
Tr_flow<-rkt(Flow_monthly$hyear,Flow_monthly$sum_flow,Flow_monthly$Month,,TRUE)
print(Tr_flow)
capture.output(summary(print(Tr_flow)), file = " Flow SMK test results.txt")
####################  partial SMK TEST FLOW
Tr_partial_flow<-rkt(Flow_monthly$hyear,Flow_monthly$sum_flow,Flow_monthly$Month,Rainfall$PRCP,TRUE)
print(Tr_partial_flow)
capture.output(summary(print(Tr_partial_flow)), file = " Flow Partial SMK test results.txt")
#####################
flow_TS<-ts(Flow_monthly[, 1], start = c(Flow_monthly$Year[1], Flow_monthly$Month[1]),end=c(Flow_monthly$Year[length(Flow_monthly$Year)],Flow_monthly$Month[length( Flow_monthly$Month)]), frequency = 12)
#########Change point detection using Lanzanteâs test
tiff(paste0("flow_monthly_lanzante_test ",".tiff"),width=1500, height=1000, res = 300)
plot(flow_TS)
s.res <- lanzante.test(flow_TS)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean(flow_TS[1:i])
s.2 <- mean(flow_TS[(i+1):n])
s <- ts(c(rep(s.1,i), rep(s.2,(n-i))))
tsp(s) <- tsp(flow_TS)
lines(s, col=2,lty=1)
print(s.res)
dev.off()
###################################
############################CDFM for monthly annuall data
Mean<- mean(Flow_monthly$sum_flow)
Flow_monthly$Pi=((Flow_monthly$sum_flow-Mean)/12)
Flow_monthly$CDFM<- cumsum(Flow_monthly$Pi) # replace the cell freq.s by cumulative freq.s
#################################################################################
lims <- c(min_date=min(Flow_monthly$date),max_date=max(Flow_monthly$date))
Flowmonthly1<-ggplot(Flow_monthly)+geom_line( aes(x=date, y=sum_flow),color= "grey")
Flowmonthly2<-Flowmonthly1+geom_line(aes(x=date, y=CDFM),alpha = 0.6, size = 0.7,color= "blue")
Flowmonthly3<-Flowmonthly2+geom_smooth(aes(x=date, y=CDFM),method="gam",color="red")+xlab("Date")+ylab("Flow (GL/month)")
Flowmonthly4<-Flowmonthly3+scale_y_continuous(sec.axis = sec_axis(name ="CDFM (GL)",~ . + 0))
Flowmonthly5<- Flowmonthly4+theme_bw()
Flowmonthly5
dev.off()
###########################
#################################### monthly flow
s.res <- lanzante.test(Flow_monthly$sum_flow)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean( Flow_monthly$sum_flow[1:i])
s.2 <- mean( Flow_monthly$sum_flow[(i+1):n])
sm<- ts(c(rep(s.1,i), rep(s.2,(n-i))))
sm<-as.data.frame(as.numeric(sm))
Flow_monthly$sm<-sm$`as.numeric(sm)`
p_value <- s.res$p.value
str(p_value)
FM<- if(p_value > 0.05){print("LAT (p>0.05)")} else if(p_value > 0.01 & p_value < 0.05){print("LAT (p<0.05)")} else{print("LAT (p<0.01)")}
my_text <- FM
my_grob = grid.text(my_text, x=0.71,  y=0.9, gp=gpar(col="black", fontsize=7, fontface="bold"))
year=Flow_monthly[i,2]

Flowmonthly10<-Flowmonthly5+geom_line(aes(x=date,y=Flow_monthly$sm),colour="black")
Flowmonthly11<-Flowmonthly10+ggtitle("Annual")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+ 
  annotation_custom(my_grob)+geom_vline(aes(xintercept = year),size = 0.7,color= "black",linetype="dashed")
Flowmonthly11
dev.off()
###########################################
####################### Orginal MK test for annual data OMK TEST
##view(Flow_yearly)
Flow_yearly$yearfraction<-(Flow_yearly$Year+0.110)
TR_annual_flow<-rkt(Flow_yearly$yearfraction,Flow_yearly$sum_flow)
print(TR_annual_flow)
capture.output(summary(print(TR_annual_flow)), file = " flow_annual MK test results.txt")

################################# ECP
#### ENERGY AGGLOMERATIVE
###x and X1 should be mattrix
Flow1<-Flow_yearly%>% dplyr::select(1)
Flow1<- as.matrix(Flow1)
x1= rep(c(min(Flow_yearly$Year):max(Flow_yearly$Year)), times= c(1))
########################
n=length(Flow_yearly$date)
num=1
mem <- vector()

while (n>11) {
  
  x= rep(c(num), times= c(11))
  
  n=n-11
  
  num=num+1
  
  mem <- append(mem, x)
  
}

x= rep(c(num), times= c(n))

mem <- append(mem, x)

print(mem)
#### mem= c=shows possible number of change point and time should the same as x=Flow1 length
tiff(paste0("flow_annual_ECP test",".tiff"),width=1500, height=1000, res = 300)
CP_Flow = e.agglo(X=Flow1,member=mem,alpha=2,penalty=function(cp,Xts) 0)
CP_Flow$estimates
CP_Flow$cluster
#plot(CP_Flow$cluster)
plot(x1, CP_Flow$cluster,
     main="ECP test flow annual",
     xlab = "Year",
     ylab="cluster",
     type="p",
     col="blue")
dev.off()
#####################################
##################################### OMK test for ANNUAL FLOW
TR_annual_flow<-rkt(Flow_yearly$yearfraction,Flow_yearly$sum_flow)
print(TR_annual_flow)
capture.output(summary(print(TR_annual_flow)), file = " Flow_annual MK test results.txt")
TR_annual_flow$sl
TR_annual_flow$B
b0<- median(Flow_yearly$sum_flow)-(TR_annual_flow$B * median(Flow_yearly$Year))
Flow_yearly$overall_slope<- b0+(TR_annual_flow$B * Flow_yearly$Year)
a1<-as.character(Flow_yearly$Year[1]) 
b1<-as.character(Flow_yearly$Year[length(Flow_yearly$Year)]) 
z1<-as.character(lapply(TR_annual_flow$B, round,2))
Flow_yearly$`Sens Slope`<- paste("a)",a1,"-",b1,":"," ",z1," ","GL/yr",sep='')
######################################
###################################### MKLTP tEST FOR ANNUALL Flow
Flow_yearly$MKLTP.Sig<-as.numeric (NA)
Flow_yearly$Mean<-as.numeric (NA)
Flow_yearly$Line<-as.numeric (NA)
Flow_yearly$overll_line<-as.numeric (Flow_yearly$overall_slope)
Flow_yearly$Line.pvalue<-as.character(NA)
Flow_yearly$Mid_date<-as.Date.numeric(NA)
Flow_yearly$mLine<- as.numeric(NA)
######################################
Flow_yearly$Max_date<- as.Date.numeric(NA) 
Flow_yearly$ECP<-as.character(NA) 
Flow_yearly$Seq_p.value<-as.numeric (NA)
Flow_yearly$MKLTP_p.value<-as.numeric (NA)
#######################################
#######################################
myts_Annuall<- ts(Flow_yearly$sum_flow, start=c(min(Flow_yearly$Year)), end=c(max(Flow_yearly$Year)), frequency=1)
MKLTP_Annuall_Flow<- MannKendallLTP(myts_Annuall)
capture.output(summary(print(MKLTP_Annuall_Flow)), file = " MKLTP annual flow1.txt")
Flow_yearly$MKLTP.Sig<- if (MKLTP_Annuall_Flow$Mann_Kendall_LTP[2]>0.01){
  paste(lapply(MKLTP_Annuall_Flow$Mann_Kendall_LTP[2], round,2))} else {0.001}
Flow_yearly$Line.pvalue<-if (Flow_yearly$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",Flow_yearly$MKLTP.Sig,")", sep = "")} else{NA}
Flow_yearly$Mid_date<-min(Flow_yearly$date)
##view(Flow_yearly)
############################
Flow_yearly$Seq<-as.numeric(CP_Flow$cluster) 
max(Flow_yearly$Seq)
max(length(Flow_yearly$Seq))
ddddddddd<-as.numeric( which(CP_Flow$cluster == max(CP_Flow$cluster)))
Flow_yearly$Seq[max(ddddddddd)+1]
jj<-max(ddddddddd)
JJJ<-as.numeric( length(Flow_yearly$Seq))
Flow_yearly$Seq[max(ddddddddd)+1]
i=Flow_yearly$Seq[max(ddddddddd)+1]
Flow_yearly$Seq[jj:JJJ]<- 
  if(i < as.numeric(Flow_yearly$Seq[max(ddddddddd)])) {as.numeric(max(CP_Flow$cluster)+1)} else{Flow_yearly$Seq}

################# SUBSET THE DATA BASED ON ecp

#for (i in Flow_yearly$Seq){  
# m<- assign(paste("segment_", i, sep = "_"),subset(Flow_yearly, Seq==i))}

######################################
##view(Flow_yearly)
Max_Seq_annuall<-max(Flow_yearly$Seq)
NNNNN<-plyr::ddply(Flow_yearly, plyr::.(Seq), function(m){
  FD<-rkt(m$yearfraction,m$sum_flow)
  capture.output(summary(print(FD)), file = " Flow_Annuall MK test results for segments.txt")
  b0<- median(m$sum_flow)-(FD$B* median(m$Year))
  m$overall_slope<- b0+(FD$B*m$Year)
  a3<-as.character(m$Year[1]) 
  b3<-as.character(m$Year[length(m$Year)]) 
  z3<-as.character(lapply(FD$B, round,2))
  m$`Sens Slope`<- paste( (if (m$Seq==1){"b)"} else if (m$Seq==2){"c)"} else if (m$Seq==3){"d)"} else if (m$Seq==4){"e)"} else if  (m$Seq==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","GL/yr",sep='')
  m$Max_date<- if (m$Seq< Max_Seq_annuall){as.Date(max(m$date))} else {as.Date.numeric(NA)}
  m$ECP<- if (m$Seq< Max_Seq_annuall){paste("ECP", m$Seq, sep = "")} else {as.character (NA)}
  m$Seq_p.value<- paste(lapply(FD$sl, round,2))
  ###################################
  myts_Annuall<- ts(m$sum_flow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
  MKLTP_Annuall_Flow<- MannKendallLTP(myts_Annuall)
  m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Annuall_Flow$Mann_Kendall_LTP[2], round,2),")", sep = "")
  #########################
  m$Mid_date<- min(m$date)
  m$Mean<-as.numeric (mean(m$sum_flow))
  m$MKLTP.Sig<- if (MKLTP_Annuall_Flow$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Annuall_Flow$Mann_Kendall_LTP[2], round,2))} else {0.001}
  m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
  m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
  m$overll_line<-as.numeric (NA)
  m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
  ########
  return(m)
}
)
##view(NNNNN)
##################################
total_flow_annuall <- rbind(Flow_yearly,NNNNN)
##view(Flow_yearly)
tiff(paste0(" Annual flow_trend_change point ",".tiff"),width=2000, height=1500, res = 350)
annual_flowtrend1<-ggplot(total_flow_annuall, aes(x=date, color=`Sens Slope`))+
  geom_point(aes( y=sum_flow),size=1)+
  ggtitle("Annuall Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+
  xlab("Date")+ylab("Flow (GL/yr)")

annual_flowtrend2<-annual_flowtrend1+geom_line(aes(y=overll_line),size=0.8,
                                               linetype= if(total_flow_annuall$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )

annual_flowtrend2<-annual_flowtrend2+geom_line(aes(y=Line),size=0.8,linetype="twodash")

annual_flowtrend3<-annual_flowtrend2+geom_line(aes(y=mLine),size=0.8,
                                               linetype= if(total_flow_annuall$MKLTP.Sig<= 0.05){"twodash"} else {"solid"})
################################
for (i in total_flow_annuall$Max_date){
  annual_flowtrend3  <- annual_flowtrend3+ 
    geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
}

annual_flowtrend4<-annual_flowtrend3+geom_text(mapping = aes(x = Max_date,
                                                             y = max(sum_flow),
                                                             label = ECP,
                                                             hjust = 1.5,
                                                             vjust = 1.5),
                                               size=3,
                                               angle=90,
                                               show.legend = FALSE,
                                               data = total_flow_annuall)

annual_flowtrend4<- annual_flowtrend4+geom_text(mapping = aes(x = Mid_date,
                                                              y = max(sum_flow),
                                                              fill=`Sens Slope`,
                                                              label = Line.pvalue,
                                                              hjust =1,
                                                              vjust = 5.5),
                                                size=2.5,
                                                angle=90,
                                                show.legend = FALSE,
                                                data = total_flow_annuall)
annual_flowtrend4
dev.off()
###############################
#################### A divisive hierarchical estimation algorithm for multiple change point analysis
################### e.divisive ENERGY DIVISIVE for annuall data
for(i in 1:5){
  ED_Annuall=e.divisive(X=Flow1,sig.lvl=0.05,R=199,k=NULL,min.size=10,alpha=1)
  if(ED_Annuall$p.values[1]<=0.05) {
    print("End of Loop") ;
    break
  } else{"KHHHH"}
  
}
#view(Flow_yearly)
#######################
if (max(ED_Annuall$cluster)<2){capture.output(print("No change point"), file = " EDP No Change point for annuall flow.txt")} else{
  flow_ED<-Flow_yearly %>% dplyr::select(1:8)
  flow_ED$Seq_ED<-as.numeric(ED_Annuall$cluster)
  ####################
  #################### MKLTP
  flow_ED$MKLTP.Sig<-as.numeric (NA)
  flow_ED$Mean<-as.numeric (NA)
  flow_ED$Line<-as.numeric (NA)
  flow_ED$overll_line<-as.numeric (flow_ED$overall_slope)
  flow_ED$Line.pvalue<-as.character(NA)
  flow_ED$mLine<- as.numeric(NA)
  #####################################
  flow_ED$Max_date_ED<- as.Date.numeric(NA) 
  flow_ED$EDP<-as.character(NA) 
  flow_ED$p.value<-as.numeric (NA)
  flow_ED$Seq_p.value<-as.numeric (NA)
  flow_ED$MKLTP_p.value<-as.numeric (NA)
  flow_ED$Mid_date_ED<-as.Date.numeric(NA)
  #####################################
  myts_Annuall_ED<- ts(flow_ED$sum_flow, start=c(min(flow_ED$Year)), end=c(max(flow_ED$Year)), frequency=1)
  MKLTP_Annuall_Flow_ED<- MannKendallLTP(myts_Annuall_ED)
  capture.output(summary(print(MKLTP_Annuall_Flow_ED)), file = " MKLTP annual flow_ED.txt")
  flow_ED$MKLTP.Sig<- if (MKLTP_Annuall_Flow_ED$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Annuall_Flow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
  flow_ED$Line.pvalue<-if (flow_ED$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",flow_ED$MKLTP.Sig,")", sep = "")} else{NA}
  flow_ED$Mid_date_ED<-min(flow_ED$date)
  ####
  ddddddddd<-as.numeric( which(ED_Annuall$cluster == max(ED_Annuall$cluster)))
  max(ddddddddd)
  str(ddddddddd)
  flow_ED$Seq_ED[max(ddddddddd)+1]
  jj<-max(ddddddddd)
  JJJ<-as.numeric( length(flow_ED$Seq_ED))
  flow_ED$Seq_ED[max(ddddddddd)+1]
  i=flow_ED$Seq_ED[max(ddddddddd)+1]
  #################
  
  #for (i inflow_ED$Seq){  
  # m<- assign(paste("segment_", i, sep = "_"),subset(flow_ED, Seq==i))}
  
  ######################################
  Max_Seq_ED_annuall<-max(flow_ED$Seq_ED)
  EDPP<-plyr::ddply(flow_ED, plyr::.(Seq_ED), function(m){
    FD<-rkt(m$yearfraction,m$sum_flow)
    FD$B
    b0<- median(m$sum_flow)-(FD$B* median(m$Year))
    m$overall_slope<- b0+(FD$B*m$Year)
    length(m$Year)
    a3<-as.character(m$Year[1]) 
    b3<-as.character(m$Year[length(m$Year)]) 
    z3<-as.character(lapply(FD$B, round,2))
    m$`Sens Slope`<- paste( (if (m$Seq_ED==1){"b)"} else if (m$Seq_ED==2){"c)"} else if (m$Seq_ED==3){"d)"} else if (m$Seq_ED==4){"e)"} else if  (m$Seq_ED==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","GL/yr",sep='')
    m$Max_date_ED<- if (m$Seq_ED< Max_Seq_ED_annuall){as.Date(max(m$date))} else {as.Date.numeric(NA)}
    m$p.value<- ED_Annuall$p.values[m$Seq_ED]
    m$EDP<- if (m$Seq_ED< Max_Seq_ED_annuall){paste("EDP", m$Seq_ED," ","p","(",m$p.value,")", sep = "")} else {as.character (NA)}
    m$Seq_p.value<- paste(lapply(FD$sl, round,2))
    m$Mid_date_ED<- median(m$date)
    #######
    myts_ED_annual <- ts(m$sum_flow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
    MKLTP_Annuall_Flow_ED<- MannKendallLTP( myts_ED_annual)
    m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Annuall_Flow_ED$Mann_Kendall_LTP[2], round,2),")", sep = "")
    #########################
    m$Mid_date_ED<- min(m$date)
    m$Mean<-as.numeric (mean(m$sum_flow))
    m$MKLTP.Sig<- if (MKLTP_Annuall_Flow_ED$Mann_Kendall_LTP[2]>0.01){
      paste(lapply(MKLTP_Annuall_Flow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
    m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
    m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
    m$overll_line<-as.numeric (NA)
    m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
    #######################
    return(m)
  }
  )
  
  #####################################################################################
  total_flow_annuall_EDP <- rbind(flow_ED,EDPP)
  ##view(total_flow_annuall_EDP)
  tiff(paste0(" Annual_trend_EDP change point ",".tiff"),width=2000, height=1500, res = 350)
  annual_flowtrend_EDP1<-ggplot( total_flow_annuall_EDP, aes(x=date,color=`Sens Slope`))+
    geom_point(aes( y=sum_flow),size=1) +xlab("Date")+ylab("Flow (GL/yr)")+
    ggtitle("Annuall Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))
  annual_flowtrend_EDP2<-annual_flowtrend_EDP1+geom_line(aes(y=mLine),size=0.8,
                                                         linetype= if( total_flow_annuall_EDP$MKLTP.Sig<= 0.050){"twodash"} else {"solid"})
  annual_flowtrend_EDP3<-annual_flowtrend_EDP2+geom_line(aes(y=Line),size=0.8,linetype="twodash")
  annual_flowtrend_EDP4<-annual_flowtrend_EDP3+geom_line(aes(y=overll_line),size=0.8,
                                                         linetype= if(total_flow_annuall_EDP$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )
  #########
  
  for (i in  total_flow_annuall_EDP$Max_date_ED){
    annual_flowtrend_EDP4  <- annual_flowtrend_EDP4+ 
      geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
  }
  
  annual_flowtrend_EDP4<-annual_flowtrend_EDP4+geom_text(mapping = aes(x = Max_date_ED,
                                                                       y = max(sum_flow),
                                                                       label = EDP,
                                                                       hjust = 1.5,
                                                                       vjust = 1.5),
                                                         size=3,
                                                         angle=90,
                                                         show.legend = FALSE,
                                                         data =total_flow_annuall_EDP)
  
  annual_flowtrend_EDP4<- annual_flowtrend_EDP4+geom_text(mapping = aes(x = Mid_date_ED,
                                                                        y = max(sum_flow),
                                                                        label = Line.pvalue,
                                                                        hjust =1,
                                                                        vjust = 5.5),
                                                          size=2.5,
                                                          angle=90,
                                                          show.legend = FALSE,
                                                          data =total_flow_annuall_EDP)
  annual_flowtrend_EDP4
}# end of if
dev.off()

#######################################
###################################### WET OR DRY SEASON
###################################### SEASONAL SMK TEST
##view(Flow_monthly)
flow_season<- Flow_monthly %>%
  mutate(season = case_when(
    Month %in% 5:10 ~ "Wet",
    Month %in%  11:12  ~ "Dry",
    Month %in%  1:4  ~ "Dry"))
Flow_wetseason <- subset(flow_season, season %in% c("Wet"))
Flow_dryseason <- subset(flow_season, season %in% c("Dry"))
#######################################################
##################### SMK test for  flow in wet and dry season
Tr_flow_Dryseason<-rkt(Flow_dryseason$Year,Flow_dryseason$sum_flow,Flow_dryseason$Month,,TRUE)
print(Tr_flow_Dryseason)
capture.output(summary(print(Tr_flow_Dryseason)), file = "flow_dryseason SMK test results.txt")

Tr_flow_Wetseason<-rkt(Flow_wetseason$Year,Flow_wetseason$sum_flow,Flow_wetseason$Month,,TRUE)
print(Tr_flow_Wetseason)
capture.output(summary(print(Tr_flow_Wetseason)), file = " flow_Wetseason SMK test results.txt")
######################### Change point detection Lanzanteâs TEST for wet and dry season
######################### dry season
tiff(paste0(" Flow_dryseason_Lanzanteâs Change point ",".tiff"),width=1500, height=1000, res = 300)
par(mfrow=c(1,1))
plot(Flow_dryseason$Year,Flow_dryseason$sum_flow)
s.res <- lanzante.test(Flow_dryseason$sum_flow)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean( Flow_dryseason$sum_flow[1:i])
s.2 <- mean(Flow_dryseason$sum_flow[(i+1):n])
s <-(c(rep(s.1,i), rep(s.2,(n-i))))
lines(Flow_dryseason$Year, s, col=2,lty=1)
print(s.res)
dev.off()
################################## WET season
tiff(paste0(" Flow_wetseason_Lanzanteâs Change point ",".tiff"),width=1500, height=1000, res = 300)
par(mfrow=c(1,1))
plot(Flow_wetseason$Year,Flow_wetseason$sum_flow)
s.res <- lanzante.test(Flow_wetseason$sum_flow)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean( Flow_wetseason$sum_flow[1:i])
s.2 <- mean(Flow_wetseason$sum_flow[(i+1):n])
s <-(c(rep(s.1,i), rep(s.2,(n-i))))
lines(Flow_wetseason$Year, s, col=2,lty=1)
print(s.res)
dev.off()
####################################
################################# CDFM for seasonal data 
################################
Flow_dryseason<-Flow_dryseason %>% dplyr::select(1:6,10)
Mean_dry<- mean(Flow_dryseason$sum_flow)
Flow_dryseason$pi_dry=((Flow_dryseason$sum_flow-Mean_dry)/6)
Flow_dryseason$CDFM_dry<- cumsum(Flow_dryseason$pi_dry) # replace the cell freq.s by cumulative freq.s
################ wet
Flow_wetseason<-Flow_wetseason %>% dplyr::select(1:6,10)
Mean_wet<- mean(Flow_wetseason$sum_flow)
Flow_wetseason$pi_wet=((Flow_wetseason$sum_flow-Mean_wet)/6)
Flow_wetseason$CDFM_wet<- cumsum(Flow_wetseason$pi_wet) 
##################################
###############  dry monthly lAN TEST
s.res <- lanzante.test(Flow_dryseason$sum_flow)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean(Flow_dryseason$sum_flow[1:i])
s.2 <- mean(Flow_dryseason$sum_flow[(i+1):n])
sd <-(c(rep(s.1,i), rep(s.2,(n-i))))
sd<-as.data.frame(as.numeric(sd))
Flow_dryseason$sd<-sd$`as.numeric(sd)`
p_value <- s.res$p.value
str(p_value)
hhh<- if(p_value > 0.05){print("LAT (p>0.05)")} else if(p_value > 0.01 & p_value < 0.05){print("LAT (p<0.05)")} else{print("LAT (p<0.01)")}
my_text1 <- hhh
my_grob1 = grid.text(my_text1, gp=gpar(col="black", fontsize=7, fontface="bold"))
year1=Flow_dryseason[i,2]
lims<- c(min= as.Date(min(Flow_dryseason$date)), max= as.Date(max(Flow_dryseason$date)))
flow_dry<-ggplot(Flow_dryseason)+geom_line(aes(x=date, y=sum_flow),color= "grey")
flow_dry<-flow_dry+geom_line(aes(x=date, y=CDFM_dry),alpha = 0.6, size = 0.7,color= "blue")
flow_dry1<-flow_dry+geom_smooth(aes(x=date, y=CDFM_dry),method="gam",color="red")+xlab("Date")+ylab("Flow (GL/month)")
flow_dry2<-flow_dry1+scale_y_continuous(sec.axis = sec_axis(name ="CDFM (GL)",~ . + 0))
flow_dry3<-flow_dry2+geom_vline(aes(xintercept = year1),size = 0.7,color= "black",linetype="dashed")
flow_dry4<-flow_dry3+geom_line(aes(x=date,y=sd),color= "black")+ggtitle("Dry Seasons")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+
  annotation_custom(my_grob1, xmin = as.Date(max(year1,100)), xmax = as.Date(max(year1,100)), ymin =max(Flow_dryseason$sum_flow), ymax = max(Flow_dryseason$sum_flow))
flow_dry4
dev.off()
##############
##################################
###############  wet monthly lAN TEST
s.res <- lanzante.test(Flow_wetseason$sum_flow)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean(Flow_wetseason$sum_flow[1:i])
s.2 <- mean(Flow_wetseason$sum_flow[(i+1):n])
sd <-(c(rep(s.1,i), rep(s.2,(n-i))))
sd<-as.data.frame(as.numeric(sd))
Flow_wetseason$sd<-sd$`as.numeric(sd)`
p_value <- s.res$p.value
str(p_value)
hwet<- if(p_value > 0.05){print("LAT (p>0.05)")} else if(p_value > 0.01 & p_value < 0.05){print("LAT (p<0.05)")} else{print("LAT (p<0.01)")}
my_text2 <- hwet
my_grob2 = grid.text(my_text2, gp=gpar(col="black", fontsize=7, fontface="bold"))
year2=Flow_wetseason[i,2]
lims<- c(min= as.Date(min(Flow_wetseason$date)), max= as.Date(max(Flow_wetseason$date)))
flow_wet<-ggplot(Flow_wetseason)+geom_line(aes(x=date, y=sum_flow),color= "grey")
flow_wet<-flow_wet+geom_line(aes(x=date, y=CDFM_wet),alpha = 0.6, size = 0.7,color= "blue")
flow_wet1<-flow_wet+geom_smooth(aes(x=date, y=CDFM_wet),method="gam",color="red")+xlab("Date")+ylab("Flow (GL/month)")
flow_wet2<-flow_wet1+scale_y_continuous(sec.axis = sec_axis(name ="CDFM (GL)",~ . + 0))
flow_wet3<-flow_wet2+geom_vline(aes(xintercept = year2),size = 0.7,color= "black",linetype="dashed")
flow_wet4<-flow_wet3+geom_line(aes(x=date,y=sd),color= "black")+ggtitle("Wet Seasons")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+
  annotation_custom(my_grob2, xmin = as.Date(max(year2,100)), xmax = as.Date(max(year2,100)), ymin =max(Flow_wetseason$sum_flow), ymax = max(Flow_wetseason$sum_flow))
flow_wet4
dev.off()
#####################
tiff(paste0("CDFM_flow",".tiff"),width=2000, height=2500, res = 350)
zk<-ggarrange(Flowmonthly11,flow_dry4,flow_wet4, nrow =3, ncol =1, heights = c(10, 10,10),
              widths =c(0.5) )
dev.off()
########################################
################################## orginal mann-kendal test
########## change point for wet and dry season ANNUALY   
Flow_wetseason
ts_wet <- xts(Flow_wetseason$sum_flow, as.Date(Flow_wetseason$date, "%Y-%m-%d"))
# convert daily data
ts_wet_y = apply.yearly(ts_wet, sum)
ts_y_w= data.frame(sum_flow=coredata(ts_wet_y),date=index(ts_wet_y))

flow_wet<- data.frame(date = ts_y_w$date,
                      Year = as.numeric(format(ts_y_w$date, format = "%Y")),
                      Month = as.numeric(format(ts_y_w$date, format = "%m")),
                      Day = as.numeric(format(ts_y_w$date, format = "%d")))
flow_wet$sum_flow<-ts_y_w$sum_flow
flow_wet$yearfraction<-(flow_wet$Year+0.110)
##view(flow_wet)
#####################################
#####################################ECP change point wet season
Flow_Wet<-flow_wet %>% dplyr::select(5)
Flow_Wet<- as.matrix(Flow_Wet)
x3= rep(c(min(flow_wet$Year):max(flow_wet$Year)), times= c(1))
##################################### mem
n1=length(flow_wet$date)
num=1
mem1 <- vector()

while (n1>11) {
  
  x= rep(c(num), times= c(11))
  
  n1=n1-11
  
  num=num+1
  
  mem1 <- append(mem1, x)
  
}

x= rep(c(num), times= c(n1))

mem1 <- append(mem1, x)

print(mem1)

#### mem= rep=shows possible number of change point and time should the same as x=flow length
CP_Flow_wet= e.agglo(Flow_Wet,member=mem1,alpha=2,penalty=function(cp,Xts) 0)
par(mfrow=c(1,1))
tiff(paste0(" ECP change point for annual wet flow ",".tiff"),width=1500, height=1000, res = 300)
CP_Flow_wet$progression
#plot(CP_Flow_wet$cluster)
plot(x3, CP_Flow_wet$cluster,
     main="ECP test annual wet Flow",
     xlab = "Year",
     ylab="cluster",
     type="p",
     col="blue")
dev.off()

########################################## orginal MK test for flow wet
TR_wet_flow<-rkt(flow_wet$yearfraction,flow_wet$sum_flow)
print(TR_wet_flow)
capture.output(summary(print(TR_wet_flow)), file = " Flow_annual_wet MK test results.txt")
TR_wet_flow$B
b0<- median(flow_wet$sum_flow)-(TR_wet_flow$B * median(flow_wet$Year))
flow_wet$overall_slope<- b0+(TR_wet_flow$B * flow_wet$Year)
length(flow_wet$Year)
a2<-as.character(flow_wet$Year[1]) 
b2<-as.character(flow_wet$Year[length(flow_wet$Year)]) 
z2<-as.character(lapply(TR_wet_flow$B, round,2))
flow_wet$`Sens Slope`<- paste("a)",a2,"-",b2,":"," ",z2," ","GL/yr",sep='')

################################################## MKLTP
flow_wet$MKLTP.Sig<-as.numeric (NA)
flow_wet$Mean<-as.numeric (NA)
flow_wet$Line<-as.numeric (NA)
flow_wet$overll_line<-as.numeric (flow_wet$overall_slope)
flow_wet$Line.pvalue<-as.character(NA)
flow_wet$Mid_date<-as.Date.numeric(NA)
flow_wet$mLine<- as.numeric (NA)
#######################
myts_Wet<- ts(flow_wet$sum_flow, start=c(min(flow_wet$Year)), end=c(max(flow_wet$Year)), frequency=1)
MKLTP_Wet_Flow<- MannKendallLTP(myts_Wet)
capture.output(summary(print(MKLTP_Wet_Flow)), file = " MKLTP annual Wet_flow.txt")
flow_wet$MKLTP.Sig<- if (MKLTP_Wet_Flow$Mann_Kendall_LTP[2]>0.01){
  paste(lapply(MKLTP_Wet_Flow$Mann_Kendall_LTP[2], round,2))} else {0.001}
flow_wet$Line.pvalue<-if (flow_wet$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",flow_wet$MKLTP.Sig,")", sep = "")} else{NA}
flow_wet$Mid_date<-min(flow_wet$date)
############################
flow_wet$Seq<-as.numeric(CP_Flow_wet$cluster) 
max(flow_wet$Seq)
max(length(flow_wet$Seq))
ddddddddd<-as.numeric( which(CP_Flow_wet$cluster == max(CP_Flow_wet$cluster)))
max(ddddddddd)
str(ddddddddd)
flow_wet$Seq[max(ddddddddd)+1]
jj<-max(ddddddddd)
JJJ<-as.numeric( length(flow_wet$Seq))
flow_wet$Seq[max(ddddddddd)+1]
#flow_dry$Seq<-if (flow_dry$Seq[max(ddddddddd)+1]< flow_dry$Seq[max(ddddddddd)]){ flow_dry$Seq[jj:JJJ]==max(CP_Flow_dry$cluster)+1}
i=flow_wet$Seq[max(ddddddddd)+1]
flow_wet$Seq[jj:JJJ]<- 
  if(i < as.numeric(flow_wet$Seq[max(ddddddddd)])) {as.numeric(max(CP_Flow_wet$cluster)+1)} else{flow_wet$Seq}
###view(flow_wet)
flow_wet$Max_date<- as.Date.numeric(NA) 
flow_wet$ECP<-as.character(NA) 
flow_wet$Seq_p.value<-as.numeric (NA)
flow_wet$MKLTP_p.value<-as.numeric (NA)
max(flow_wet$Seq)
#################
#for (i in flow_wet$Seq){  
# m<- assign(paste("segment_wet", i, sep = "_"),subset(flow_wet, Seq==i))}
######################################
Max_Seq_wet<-max(flow_wet$Seq)
SSSSS<-plyr::ddply(flow_wet, plyr::.(Seq), function(m){
  FD<-rkt(m$yearfraction,m$sum_flow)
  b0<- median(m$sum_flow)-(FD$B* median(m$Year))
  m$overall_slope<- b0+(FD$B*m$Year)
  length(m$Year)
  a3<-as.character(m$Year[1]) 
  b3<-as.character(m$Year[length(m$Year)]) 
  z3<-as.character(lapply(FD$B, round,2))
  m$`Sens Slope`<- paste( (if (m$Seq==1){"b)"} else if (m$Seq==2){"c)"} else if (m$Seq==3){"d)"} else if (m$Seq==4){"e)"} else if  (m$Seq==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","GL/yr",sep='')
  m$Max_date<- if (m$Seq< Max_Seq_wet){as.Date(max(m$date))} else {as.Date.numeric(NA)}
  m$ECP<- if (m$Seq< Max_Seq_wet){paste("ECP", m$Seq, sep = "")} else {as.character (NA)}
  m$Seq_p.value<- paste(lapply(FD$sl, round,2))
  #############
  myts_Wet <- ts(m$sum_flow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
  MKLTP_Wet_Flow<- MannKendallLTP(myts_Wet)
  m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Wet_Flow$Mann_Kendall_LTP[2], round,2),")", sep = "")
  ############################
  m$Mid_date<- min(m$date)
  m$Mean<-as.numeric (mean(m$sum_flow))
  m$MKLTP.Sig<- if (MKLTP_Wet_Flow$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Wet_Flow$Mann_Kendall_LTP[2], round,2))} else {0.001}
  m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
  m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
  m$overll_line<-as.numeric (NA)
  m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
  #################
  print(m$ECP)
  return(m)
}
)
##view(SSSSS)
###############################
total_flow_wet <- rbind(flow_wet,SSSSS)
###############
tiff(paste0(" Annual_wet_trend_change point ",".tiff"),width=2000, height=1500, res = 350)
Wet_flowtrend1<-ggplot(total_flow_wet, aes(x=date, color=`Sens Slope`))+
  geom_point(aes(y=sum_flow, color=`Sens Slope`),size=1)+
  ggtitle("Wet Seasons Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+
  xlab("Date")+ylab("Flow (GL/yr)")
Wet_flowtrend2<-Wet_flowtrend1+geom_line(aes(y=overll_line),size=0.8,
                                         linetype= if(total_flow_wet$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )
Wet_flowtrend3<-Wet_flowtrend2+geom_line(aes(y=Line),size=0.8,linetype="twodash")
Wet_flowtrend4<-Wet_flowtrend3+geom_line(aes(y=mLine),size=0.8,
                                         linetype= if(total_flow_wet$MKLTP.Sig<= 0.05){"solid"} else {"twodash"})                                         

#################
for (i in total_flow_wet$Max_date){
  Wet_flowtrend4<- Wet_flowtrend4+ 
    geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
}

Wet_flowtrend4<-Wet_flowtrend4+geom_text(mapping = aes(x = Max_date,
                                                       y = max(sum_flow),
                                                       label = ECP,
                                                       hjust = 1.5,
                                                       vjust = 1.5),
                                         size=2.5,
                                         angle=90,
                                         show.legend = FALSE,
                                         data = total_flow_wet)

Wet_flowtrend4<-Wet_flowtrend4+geom_text(mapping = aes(x=Mid_date,
                                                       y = max(sum_flow),
                                                       fill=`Sens Slope`,
                                                       label = Line.pvalue,
                                                       hjust = 1,
                                                       vjust = 3),
                                         size=2.5,
                                         angle=90,
                                         show.legend = FALSE,
                                         data = total_flow_wet)

Wet_flowtrend4
dev.off()

####################
################### A divisive hierarchical estimation algorithm for multiple change point analysis
################### e.divisive ENERGY DIVISIVE for annuall data
for(i in 1:5){
  ED_Wet=e.divisive(X=Flow_Wet,sig.lvl=0.05,R=199,k=NULL,min.size=10,alpha=1)
  if(ED_Wet$p.values[1]<=0.05) {
    print("End of Loop") ;
    break
  } else{"KHHHH"}
  
}

if (max(ED_Wet$cluster)<2){capture.output(print("No change point"), file = " EDP No Change point for wet season flow.txt")} else{
  flow_ED_Wet<-flow_wet %>% dplyr::select(1:8)
  flow_ED_Wet$Seq_ED<-as.numeric(ED_Wet$cluster) 
  ########################################
  ##view(flow_ED_Wet)
  ################################################## MKLTP
  flow_ED_Wet$MKLTP.Sig<-as.numeric (NA)
  flow_ED_Wet$Mean<-as.numeric (NA)
  flow_ED_Wet$Line<-as.numeric (NA)
  flow_ED_Wet$overll_line<-as.numeric (flow_ED_Wet$overall_slope)
  flow_ED_Wet$Line.pvalue<-as.character(NA)
  flow_ED_Wet$mLine<- as.numeric (NA)
  ########################
  flow_ED_Wet$Max_date_ED<- as.Date.numeric(NA) 
  flow_ED_Wet$EDP<-as.character(NA) 
  flow_ED_Wet$p.value<-as.numeric (NA)
  flow_ED_Wet$Seq_p.value<-as.numeric (NA)
  flow_ED_Wet$MKLTP_p.value<-as.numeric (NA)
  flow_ED_Wet$Mid_date_ED<-as.Date.numeric(NA)
  ###################################
  myts_Wet_ED<- ts(flow_ED_Wet$sum_flow, start=c(min(flow_ED_Wet$Year)), end=c(max(flow_ED_Wet$Year)), frequency=1)
  MKLTP_Wet_Flow_ED<- MannKendallLTP(myts_Wet_ED)
  capture.output(summary(print(MKLTP_Wet_Flow_ED)), file = " MKLTP annual Wet_flow_ED.txt")
  flow_ED_Wet$MKLTP.Sig<- if (MKLTP_Wet_Flow_ED$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Wet_Flow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
  flow_ED_Wet$Line.pvalue<-if (flow_ED_Wet$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",flow_ED_Wet$MKLTP.Sig,")", sep = "")} else{NA}
  flow_ED_Wet$Mid_date_ED<-min(flow_ED_Wet$date)
  ############################
  ###########################
  max(flow_ED_Wet$Seq_ED)
  max(length(flow_ED_Wet$Seq_ED))
  ddddddddd<-as.numeric( which(ED_Wet$cluster == max(ED_Wet$cluster)))
  flow_ED_Wet$Seq_ED[max(ddddddddd)+1]
  jj<-max(ddddddddd)
  JJJ<-as.numeric( length(flow_ED_Wet$Seq_ED))
  flow_ED_Wet$Seq_ED[max(ddddddddd)+1]
  #flow_ED_Wet_dry$Seq<-if (flow_ED_Wet_dry$Seq[max(ddddddddd)+1]< flow_ED_Wet_dry$Seq[max(ddddddddd)]){ flow_ED_Wet_dry$Seq[jj:JJJ]==max(CP_flow_ED_Wet_dry$cluster)+1}
  i=flow_ED_Wet$Seq_ED[max(ddddddddd)+1]
  #flow_ED_Wet$Seq_ED[jj:JJJ]<- 
  # if(i < as.numeric(flow_ED_Wet$Seq_ED[max(ddddddddd)])) {as.numeric(max(ED_Wet$cluster)+1)} else{flow_ED_Wet$Seq_ED}
  #################
  #for (i in flow_ED_Wet$Seq){  
  # m<- assign(paste("segment_", i, sep = "_"),subset(flow_ED_Wet, Seq==i))}
  ######################################
  Max_Seq_ED_Wet<-max(flow_ED_Wet$Seq_ED)
  EDPP<-plyr::ddply(flow_ED_Wet, plyr::.(Seq_ED), function(m){
    FD<-rkt(m$yearfraction,m$sum_flow)
    b0<- median(m$sum_flow)-(FD$B* median(m$Year))
    m$overall_slope<- b0+(FD$B*m$Year)
    length(m$Year)
    a3<-as.character(m$Year[1]) 
    b3<-as.character(m$Year[length(m$Year)]) 
    z3<-as.character(lapply(FD$B, round,2))
    m$`Sens Slope`<- paste( (if (m$Seq_ED==1){"b)"} else if (m$Seq_ED==2){"c)"} else if (m$Seq_ED==3){"d)"} else if (m$Seq_ED==4){"e)"} else if  (m$Seq_ED==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","GL/yr",sep='')
    m$Max_date_ED<- if (m$Seq_ED< Max_Seq_ED_Wet){as.Date(max(m$date))} else {as.Date.numeric(NA)}
    m$p.value<- ED_Wet$p.values[m$Seq_ED]
    m$EDP<- if (m$Seq_ED< Max_Seq_ED_Wet){paste("EDP", m$Seq_ED," ","p","(",m$p.value,")", sep = "")} else {as.character (NA)}
    m$Seq_p.value<- paste(lapply(FD$sl, round,2))
    ######
    myts_Wet_ED <- ts(m$sum_flow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
    MKLTP_Wet_Flow_ED<- MannKendallLTP(myts_Wet_ED)
    m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Wet_Flow_ED$Mann_Kendall_LTP[2], round,2),")", sep = "")
    ########################
    m$Mid_date_ED<- min(m$date)
    m$Mean<-as.numeric (mean(m$sum_flow))
    m$MKLTP.Sig<- if (MKLTP_Wet_Flow_ED$Mann_Kendall_LTP[2]>0.01){
      paste(lapply(MKLTP_Wet_Flow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
    m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
    m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
    m$overll_line<-as.numeric (NA)
    m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
    #################
    return(m)
  }
  )
  
  #####################################################################################
  total_flow_Wet_EDP <- rbind(flow_ED_Wet,EDPP)
  ##view(flow_ED_Wet)
  #view( total_flow_Wet_EDP)
  tiff(paste0(" Wet_trend_EDP change point ",".tiff"),width=2000, height=1500, res = 350)
  Wet_flowtrend_EDP1<-ggplot( total_flow_Wet_EDP, aes(x=date, color=`Sens Slope`))+
    geom_point(aes(y=sum_flow, color=`Sens Slope`),size=1)+xlab("Date")+ylab("Flow (GL/yr)")+
    ggtitle("Wet Season Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))
  Wet_flowtrend_EDP2<-Wet_flowtrend_EDP1+geom_line(aes(y=overll_line),size=0.8,
                                                   linetype= if( total_flow_Wet_EDP$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )
  Wet_flowtrend_EDP3<-Wet_flowtrend_EDP2+geom_line(aes(y=Line),size=0.8,linetype="twodash")
  Wet_flowtrend_EDP4<-Wet_flowtrend_EDP3+ geom_line(aes(y=mLine),size=0.8,
                                                    linetype= if( total_flow_Wet_EDP$MKLTP.Sig<= 0.05){"solid"} else {"twodash"})                                         
  
  ##########
  
  for (i in  total_flow_Wet_EDP$Max_date_ED){
    Wet_flowtrend_EDP4  <- Wet_flowtrend_EDP4+ 
      geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
  }
  
  Wet_flowtrend_EDP4<-Wet_flowtrend_EDP4+geom_text(mapping = aes(x = Max_date_ED,
                                                                 y = max(sum_flow),
                                                                 label = EDP,
                                                                 hjust = 1.5,
                                                                 vjust = 1.5),
                                                   size=3,
                                                   angle=90,
                                                   show.legend = FALSE,
                                                   data =  total_flow_Wet_EDP)
  
  Wet_flowtrend_EDP4<-Wet_flowtrend_EDP4+geom_text(mapping = aes(x = Mid_date_ED,
                                                                 y = max(sum_flow),
                                                                 label = Line.pvalue,
                                                                 hjust = 1,
                                                                 vjust = 5.5), 
                                                   size=2.5,  
                                                   angle=90,
                                                   show.legend = FALSE,
                                                   data =  total_flow_Wet_EDP)
  Wet_flowtrend_EDP4
  
}# end of if
dev.off()
############################
################################## orginal mann-kendal test
########## change point for wet and dry season ANNUALY   
Flow_dryseason
ts_dry <- xts(Flow_dryseason$sum_flow, as.Date(Flow_dryseason$date, "%Y-%m-%d"))
# convert daily data
ts_dry_y = apply.yearly(ts_dry, sum)
ts_y_d= data.frame(sum_flow=coredata(ts_dry_y),date=index(ts_dry_y))

flow_dry<- data.frame(date = ts_y_d$date,
                      Year = as.numeric(format(ts_y_d$date, format = "%Y")),
                      Month = as.numeric(format(ts_y_d$date, format = "%m")),
                      Day = as.numeric(format(ts_y_d$date, format = "%d")))
flow_dry$sum_flow<-ts_y_d$sum_flow
flow_dry$yearfraction<-(flow_dry$Year+0.110)
##view(flow_dry)
#####################################
#####################################ECP change point wet season
Flow_dry<-flow_dry %>% dplyr::select(5)
Flow_dry<- as.matrix(Flow_dry)
x4= rep(c(min(flow_dry$Year):max(flow_dry$Year)), times= c(1))
##################################### mem
n3=length(flow_dry$date)
num=1
mem3 <- vector()

while (n3>11) {
  
  x= rep(c(num), times= c(11))
  
  n3=n3-11
  
  num=num+1
  
  mem3 <- append(mem3, x)
  
}

x= rep(c(num), times= c(n3))

mem3 <- append(mem3, x)

print(mem3)

#### mem= rep=shows possible number
CP_Flow_dry= e.agglo(Flow_dry,member=mem3,alpha=2,penalty=function(cp,Xts) 0)
CP_Flow_dry$estimates
CP_Flow_dry$cluster
par(mfrow=c(1,1))
tiff(paste0(" ECP change point for annual dry Flow ",".tiff"),width=1500, height=1000, res = 300)
CP_Flow_dry$progression
#plot(CP_Flow_dry$cluster)
plot(x4, CP_Flow_dry$cluster,
     main="ECP test annual dry Flow",
     xlab = "Year",
     ylab="cluster",
     type="p",
     col="blue")
dev.off()
########################################## orginal MK test for Dry Flow
flow_dry
TR_dry_flow<-rkt(flow_dry$yearfraction,flow_dry$sum_flow)
print(TR_dry_flow)
capture.output(summary(print(TR_dry_flow)), file = " Flow_annual_dry MK test results.txt")
TR_dry_flow$B
b0<- median(flow_dry$sum_flow)-(TR_dry_flow$B * median(flow_dry$Year))
flow_dry$overall_slope<- b0+(TR_dry_flow$B * flow_dry$Year)
length(flow_dry$Year)
a5<-as.character(flow_dry$Year[1]) 
b5<-as.character(flow_dry$Year[length(flow_dry$Year)]) 
z5<-as.character(lapply(TR_dry_flow$B, round,2))
flow_dry$`Sens Slope`<- paste("a)",a5,"-",b5,":"," ",z5," ","GL/yr",sep='')
##################################################
################################################## MKLTP
flow_dry$MKLTP.Sig<-as.numeric (NA)
flow_dry$Mean<-as.numeric (NA)
flow_dry$Line<-as.numeric (NA)
flow_dry$overll_line<-as.numeric (flow_dry$overall_slope)
flow_dry$Line.pvalue<-as.character(NA)
flow_dry$Mid_date<-as.Date.numeric(NA)
flow_dry$mLine<- as.numeric(NA)
######################################
myts_Dry<- ts(flow_dry$sum_flow, start=c(min(flow_dry$Year)), end=c(max(flow_dry$Year)), frequency=1)
MKLTP_Dry_Flow<- MannKendallLTP(myts_Dry)
capture.output(summary(print(MKLTP_Dry_Flow)), file = " MKLTP annual Dry_flow.txt")
flow_dry$MKLTP.Sig<- if (MKLTP_Dry_Flow$Mann_Kendall_LTP[2]>0.01){
  paste(lapply(MKLTP_Dry_Flow$Mann_Kendall_LTP[2], round,2))} else {0.001}
flow_dry$Line.pvalue<-if (flow_dry$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",flow_dry$MKLTP.Sig,")", sep = "")} else{NA}
flow_dry$Mid_date<-min(flow_dry$date)
############################
flow_dry$Seq<-as.numeric(CP_Flow_dry$cluster)
ddddddddd<-as.numeric( which(CP_Flow_dry$cluster == max(CP_Flow_dry$cluster)))
flow_dry$Seq[max(ddddddddd)+1]
jj<-max(ddddddddd)
JJJ<-as.numeric( length(flow_dry$Seq))
flow_dry$Seq[max(ddddddddd)+1]
i=flow_dry$Seq[max(ddddddddd)+1]
flow_dry$Seq[jj:JJJ]<- 
  if(i < as.numeric(flow_dry$Seq[max(ddddddddd)])) {as.numeric(max(CP_Flow_dry$cluster)+1)} else{flow_dry$Seq}
##########################################
flow_dry$Max_date<- as.Date.numeric(NA) 
flow_dry$ECP<-as.character(NA)
flow_dry$Seq_p.value<-as.numeric (NA)
flow_dry$MKLTP_p.value<-as.numeric (NA)
#################

#for (i in flow_dry$Seq){  
# m<- assign(paste("segment_wet", i, sep = "_"),subset(flow_dry, Seq==i))}

######################################
Max_Seq_dry<-max(flow_dry$Seq)
VVVVV<-plyr::ddply(flow_dry, plyr::.(Seq), function(m){
  FD<-rkt(m$yearfraction,m$sum_flow)
  b0<- median(m$sum_flow)-(FD$B* median(m$Year))
  m$overall_slope<- b0+(FD$B*m$Year)
  a6<-as.character(m$Year[1]) 
  b6<-as.character(m$Year[length(m$Year)]) 
  z6<-as.character(lapply(FD$B, round,2))
  m$`Sens Slope`<- paste( (if (m$Seq==1){"b)"} else if (m$Seq==2){"c)"} else if (m$Seq==3){"d)"} else if (m$Seq==4){"e)"} else if  (m$Seq==5){"f)"} else {"g)"}) ,a6,"-",b6,":"," ",z6," ","GL/yr",sep='')
  m$Max_date<- if (m$Seq< Max_Seq_dry){as.Date(max(m$date))} else {as.Date.numeric(NA)}
  m$ECP<- if (m$Seq< Max_Seq_dry){paste("ECP", m$Seq, sep = "")} else {as.character (NA)}
  m$Seq_p.value<- paste(lapply(FD$sl, round,2))
  ######
  myts_Dry <- ts(m$sum_flow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
  MKLTP_Dry_Flow<- MannKendallLTP(myts_Dry)
  m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Dry_Flow$Mann_Kendall_LTP[2], round,2),")", sep = "")
  ############################
  m$Mid_date<- min(m$date)
  m$Mean<-as.numeric (mean(m$sum_flow))
  m$MKLTP.Sig<- if (MKLTP_Dry_Flow$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Dry_Flow$Mann_Kendall_LTP[2], round,2))} else {0.001}
  m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
  m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
  m$overll_line<-as.numeric (NA)
  m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
  #################
  
  print(m$ECP)
  return(m)
}
)

###view(VVVVV)
#####################################
total_flow_dry <- rbind(flow_dry,VVVVV)
####view(total_flow_dry)
tiff(paste0(" Annual_dry_trend_change point ",".tiff"),width=2000, height=1500, res = 350)
Dry_flowtrend1<-ggplot(total_flow_dry, aes(x=date, color=`Sens Slope`))+
  geom_point(aes(y=sum_flow, color=`Sens Slope`),size=1)+xlab("Date")+ylab("Flow (GL/yr)")+
  ggtitle("Dry Seasons Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))

Dry_flowtrend2<-Dry_flowtrend1+ geom_line(aes(y=overll_line),size=0.8,
                                          linetype= if(total_flow_dry$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )
Dry_flowtrend3<-Dry_flowtrend2+geom_line(aes(y=Line),size=0.8,linetype="twodash")
Dry_flowtrend4<-Dry_flowtrend3+geom_line(aes(y=mLine),size=0.8,
                                         linetype= if(total_flow_dry$MKLTP.Sig<= 0.05){"solid"} else {"twodash"})
######################
for (i in total_flow_dry$Max_date){
  Dry_flowtrend4  <- Dry_flowtrend4+ 
    geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
}

Dry_flowtrend4<-Dry_flowtrend4+geom_text(mapping = aes(x = Max_date,
                                                       y = max(sum_flow),
                                                       label = ECP,
                                                       hjust = 1.5,
                                                       vjust = 1.5),
                                         size=2.5,
                                         angle=90,
                                         show.legend = FALSE,
                                         data = total_flow_dry)
Dry_flowtrend4<- Dry_flowtrend4+geom_text(mapping = aes(x = Mid_date,
                                                        y = max(sum_flow),
                                                        fill=`Sens Slope`,
                                                        label = Line.pvalue,
                                                        hjust = 1,
                                                        vjust = 5.5),
                                          size=2.5,
                                          angle=90,
                                          show.legend = FALSE,
                                          data = total_flow_dry)


Dry_flowtrend4

dev.off()

######################################################################################
################### A divisive hierarchical estimation algorithm for multiple change point analysis
################### e.divisive ENERGY DIVISIVE for annuall data
Flow_dry
for(i in 1:15){
  ED_Dry=e.divisive(X=Flow_dry,sig.lvl=0.05,R=199,k=NULL,min.size=10,alpha=1)
  if(ED_Dry$p.values[1]<=0.05) {
    print("End of Loop") ;
    break
  } else{"KHHHH"}
  
}
###view(flow_dry)
if (max(ED_Dry$cluster)<2){capture.output(print("No change point"), file = " EDP No Change point for Dry season flow.txt")} else{
  flow_ED_Dry<-flow_dry %>% dplyr::select(1:8)
  flow_ED_Dry$Seq_ED<-as.numeric(ED_Dry$cluster) 
  ################################################
  ################################################## MKLTP
  flow_ED_Dry$MKLTP.Sig<-as.numeric (NA)
  flow_ED_Dry$Mean<-as.numeric (NA)
  flow_ED_Dry$Line<-as.numeric (NA)
  flow_ED_Dry$overll_line<-as.numeric (flow_ED_Dry$overall_slope)
  flow_ED_Dry$Line.pvalue<-as.character(NA)
  flow_ED_Dry$mLine<- as.numeric(NA)
  #####################################################
  flow_ED_Dry$Max_date_ED<- as.Date.numeric(NA) 
  flow_ED_Dry$EDP<-as.character(NA) 
  flow_ED_Dry$p.value<-as.numeric (NA)
  flow_ED_Dry$Seq_p.value<-as.numeric (NA)
  flow_ED_Dry$MKLTP_p.value<-as.numeric (NA)
  flow_ED_Dry$Mid_date_ED<-as.Date.numeric(NA)
  ##################################################
  ######################################
  myts_Dry_ED<- ts(flow_ED_Dry$sum_flow, start=c(min(flow_ED_Dry$Year)), end=c(max(flow_ED_Dry$Year)), frequency=1)
  MKLTP_Dry_Flow_ED<- MannKendallLTP(myts_Dry_ED)
  capture.output(summary(print(MKLTP_Dry_Flow_ED)), file = " MKLTP annual Dry_flow_ED.txt")
  flow_ED_Dry$MKLTP.Sig<- if (MKLTP_Dry_Flow_ED$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Dry_Flow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
  flow_ED_Dry$Line.pvalue<-if (flow_ED_Dry$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",flow_ED_Dry$MKLTP.Sig,")", sep = "")} else{NA}
  flow_ED_Dry$Mid_date_ED<-min(flow_ED_Dry$date)
  ############################
  ddddddddd<-as.numeric( which(ED_Dry$cluster == max(ED_Dry$cluster)))
  flow_ED_Dry$Seq_ED[max(ddddddddd)+1]
  jj<-max(ddddddddd)
  JJJ<-as.numeric( length(flow_ED_Dry$Seq_ED))
  flow_ED_Dry$Seq_ED[max(ddddddddd)+1]
  i=flow_ED_Dry$Seq_ED[max(ddddddddd)+1]
  #################
  
  #for (i in flow_ED_Dry$Seq){  
  # m<- assign(paste("segment_", i, sep = "_"),subset(flow_ED_Dry, Seq==i))}
  
  ######################################
  Max_Seq_ED_Dry<-max(flow_ED_Dry$Seq_ED)
  EDPP<-plyr::ddply(flow_ED_Dry, plyr::.(Seq_ED), function(m){
    FD<-rkt(m$yearfraction,m$sum_flow)
    b0<- median(m$sum_flow)-(FD$B* median(m$Year))
    m$overall_slope<- b0+(FD$B*m$Year)
    length(m$Year)
    a3<-as.character(m$Year[1]) 
    b3<-as.character(m$Year[length(m$Year)]) 
    z3<-as.character(lapply(FD$B, round,2))
    m$`Sens Slope`<- paste( (if (m$Seq_ED==1){"b)"} else if (m$Seq_ED==2){"c)"} else if (m$Seq_ED==3){"d)"} else if (m$Seq_ED==4){"e)"} else if  (m$Seq_ED==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","GL/yr",sep='')
    m$Max_date_ED<- if (m$Seq_ED< Max_Seq_ED_Dry){as.Date(max(m$date))} else {as.Date.numeric(NA)}
    m$p.value<- ED_Dry$p.values[m$Seq_ED]
    m$EDP<- if (m$Seq_ED< Max_Seq_ED_Dry){paste("EDP", m$Seq_ED," ","p","(",m$p.value,")", sep = "")} else {as.character (NA)}
    m$Seq_p.value<- paste(lapply(FD$sl, round,2))
    ################
    myts_Dry_ED <- ts(m$sum_flow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
    MKLTP_Dry_Flow_ED<- MannKendallLTP(myts_Dry_ED)
    m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Dry_Flow_ED$Mann_Kendall_LTP[2], round,2),")", sep = "")
    ########################
    m$Mid_date_ED<- min(m$date)
    m$Mean<-as.numeric (mean(m$sum_flow))
    m$MKLTP.Sig<- if (MKLTP_Dry_Flow_ED$Mann_Kendall_LTP[2]>0.01){
      paste(lapply(MKLTP_Dry_Flow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
    m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
    m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
    m$overll_line<-as.numeric (NA)
    m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
    #################
    return(m)
  }
  )
  #####################################################################################
  total_flow_Dry_EDP <- rbind(flow_ED_Dry,EDPP)
  ##view(flow_ED_Dry)
  tiff(paste0(" Dry_trend_EDP change point ",".tiff"),width=2000, height=1500, res = 350)
  Dry_flowtrend_EDP1<-ggplot(total_flow_Dry_EDP, aes(x=date, color=`Sens Slope`))+
    geom_point(aes(y=sum_flow, color=`Sens Slope`),size=1)+xlab("Date")+ylab("Flow (GL/yr)")+
    ggtitle("Dry Season Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))
  Dry_flowtrend_EDP2<-Dry_flowtrend_EDP1+geom_line(aes(y=overll_line),size=0.8,
                                                   linetype= if(total_flow_Dry_EDP$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} ) 
  Dry_flowtrend_EDP3<-Dry_flowtrend_EDP2+geom_line(aes(y=Line),size=0.8,linetype="twodash")
  Dry_flowtrend_EDP4<-Dry_flowtrend_EDP3+geom_line(aes(y=mLine),size=0.8,
                                                   linetype= if(total_flow_Dry_EDP$MKLTP.Sig<= 0.05){"twodash"} else {"solid"})
  #################################
  for (i in total_flow_Dry_EDP$Max_date_ED){
    Dry_flowtrend_EDP4  <- Dry_flowtrend_EDP4+ 
      geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
  }
  
  Dry_flowtrend_EDP4<-Dry_flowtrend_EDP4+geom_text(mapping = aes(x = Max_date_ED,
                                                                 y = max(sum_flow),
                                                                 label = EDP,
                                                                 hjust = 1.5,
                                                                 vjust = 1.5),
                                                   size=3,
                                                   angle=90,
                                                   show.legend = FALSE,
                                                   data = total_flow_Dry_EDP)
  
  Dry_flowtrend_EDP4<-Dry_flowtrend_EDP4+geom_text(mapping = aes(x = Mid_date_ED,
                                                                 y = max(sum_flow),
                                                                 fill=`Sens Slope`,
                                                                 label = Line.pvalue,
                                                                 hjust = 1,
                                                                 vjust = 5.5),
                                                   size=2.5,
                                                   angle=90,
                                                   show.legend = FALSE,
                                                   data = total_flow_Dry_EDP)
  Dry_flowtrend_EDP4
  
}# end of if
dev.off()

##################################### Ratio of DRY/Wet
flow_dry
flow_wet
RDW<- flow_wet$sum_flow
RDW<- as.data.frame(RDW)
RDW$Dry<- flow_dry$sum_flow
RDW$Wet<-RDW$RDW
RDW$divided<-RDW$Dry/RDW$Wet
RDW$Comulative<- cumsum(RDW$divided)
RDW$Percent<- RDW$divided*100
RDW$Year<-flow_wet$date  
###view(RDW)
RDW1<-ggplot(RDW)+geom_line(aes(x=Year,y=Percent),color="blue")+ xlab("Date")+ylab("Dry / Wet (%)")+
  geom_smooth(aes(x=Year,y=Percent), color="red")
RDW2<-RDW1+theme_bw()
RDW2
###################################
##################################### multiple graph
tiff(paste0(" Annual_wet_dry season trend ",".tiff"),width=2000, height=2500, res = 350)
f<-ggarrange(annual_flowtrend4,Dry_flowtrend4,Wet_flowtrend4, nrow =3, ncol =1, heights = c(10, 10,10),
             widths =c(0.5) )
dev.off()
#######################################
#######################################
#######################################   Baseflow analysis
Pin <- Flow
str(Pin)
colnames(Pin) <- c("Date", "Q")
####### Baseflow based on a=0.975
Summary<-baseflows(Pin,a=0.975, ts="mean")
B_annuall<- baseflows(Pin,a=0.975, ts="annual")
Daily<- baseflows(Pin,a=0.975, ts="daily")
Daily$quickflow<-  Daily$Q - Daily$bf
write.csv(Daily,file = "baseflow.csv")
###########################
baseflow <- Daily
#view(baseflow)
baseflow<-baseflow%>% dplyr::select(1,3)
str(baseflow)
Baseflow<- na.omit(baseflow) 
################################
################## avarage baseflow based on month of each year
ts_baseflow <- xts(Baseflow$bf, as.Date(Baseflow$Date, "%Y-%m-%d"))
# convert daily data to annual and monthly
ts_m_baseflow = apply.monthly(ts_baseflow, sum)
ts_y_baseflow = apply.yearly(ts_baseflow, sum)
##ts_q = apply.quarterly(ts, sum)
str(ts_m_baseflow)
ts_m_bf=data.frame(sum_baseflow=coredata(ts_m_baseflow),date=index(ts_m_baseflow))
ts_y_bf=data.frame(sum_baseflow=coredata(ts_y_baseflow),date=index(ts_y_baseflow))
Baseflow_monthly= ts_m_bf %>% 
  mutate(date = ymd(date)) %>% 
  mutate_at(vars(date), funs(year, month, day))
Baseflow_yearly= ts_y_bf %>% 
  mutate(date = ymd(date)) %>% 
  mutate_at(vars(date), funs(year, month, day))
colnames(Baseflow_monthly) <- c("sum_baseflow","date","Year","Month","Day")
colnames(Baseflow_yearly) <- c("sum_baseflow","date","Year","Month","Day")
##view(Baseflow_monthly)
#####str(Flow_monthly)
############################### hydrological year
Baseflow_season<-Baseflow_monthly
Baseflow_monthly$hyear<- ifelse(Baseflow_monthly$Month>=5,Baseflow_monthly$Year,Baseflow_monthly$Year-1)
################################ SMK test for baseflow
Tr_baseflow<-rkt(Baseflow_monthly$hyear,Baseflow_monthly$sum_baseflow,Baseflow_monthly$Month,,TRUE)
print(Tr_baseflow)
capture.output(summary(print(Tr_baseflow)), file = " Baseflow SMK test results.txt")
###### Rainfall for partial SMK Test
Rainfall <- read_excel("Rainfall.xlsx", col_types = c("numeric", 
                                                      "numeric", "numeric"))
####################  partial SMK TEST FLOW
Tr_partial_baseflow<-rkt(Baseflow_monthly$Year,Baseflow_monthly$sum_baseflow,Baseflow_monthly$Month,Rainfall$PRCP,TRUE)
print(Tr_partial_baseflow)
capture.output(summary(print(Tr_partial_baseflow)), file = " Baseflow Partial SMK test results.txt")

#########################lanzante.test monthly test 
Baseflow_TS <-ts(Baseflow_monthly[, 1], start = c(Baseflow_monthly$Year[1], Baseflow_monthly$Month[1]),
                 end=c(Baseflow_monthly$Year[length(Baseflow_monthly$Year)],Baseflow_monthly$Month[length(Baseflow_monthly$Month)]), frequency = 12)

tiff(paste0("Baseflow_monthly_lanzante_test ",".tiff"),width=1500, height=1000, res = 300)
plot(Baseflow_TS)
s.res <- lanzante.test(Baseflow_TS)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean(Baseflow_TS[1:i])
s.2 <- mean(Baseflow_TS[(i+1):n])
s <- ts(c(rep(s.1,i), rep(s.2,(n-i))))
tsp(s) <- tsp(Baseflow_TS)
lines(s, col=2,lty=1)
print(s.res)
dev.off()
################## CDFM
Mean_baseflow<- mean(Baseflow_monthly$sum_baseflow)
Baseflow_monthly$Pi=((Baseflow_monthly$sum_baseflow-Mean_baseflow)/12)
Baseflow_monthly$CDFM<- cumsum(Baseflow_monthly$Pi) # replace the cell freq.s by cumulative freq.s
#################################################################################
######### Plotting CDFM
lims<- c(min= as.Date(min(Baseflow_monthly$date)), max= as.Date(max(Baseflow_monthly$date)))
Time_Baseflow1<-ggplot(Baseflow_monthly)+geom_line( aes(x=date, y=sum_baseflow),color= "grey")
Time_Baseflow2<-Time_Baseflow1+geom_line(aes(x=date, y=CDFM),alpha = 0.6, size = 0.7,color= "blue")
Time_Baseflow3<-Time_Baseflow2+geom_smooth(aes(x=date, y=CDFM),color="red")+xlab("Date")+ylab("Baseflow (GL/month)")
Time_Baseflow4<-Time_Baseflow3+scale_y_continuous(sec.axis = sec_axis(name ="CDFM (GL)",~ . + 0))
Time_Baseflow5<- Time_Baseflow4 
Time_Baseflow5
dev.off()
#########################################
#################################### monthly baseflow
s.res <- lanzante.test( Baseflow_monthly$sum_baseflow)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean( Baseflow_monthly$sum_baseflow[1:i])
s.2 <- mean( Baseflow_monthly$sum_baseflow[(i+1):n])
sm<- ts(c(rep(s.1,i), rep(s.2,(n-i))))
sm<-as.data.frame(as.numeric(sm))
Baseflow_monthly$sm<-sm$`as.numeric(sm)`
p_value <- s.res$p.value
hh<- if(p_value > 0.05){print("LAT (p>0.05)")} else if(p_value > 0.01 & p_value < 0.05){print("LAT (p<0.05)")} else{print("LAT (p<0.01)")}
my_text <- hh
my_grob = grid.text(my_text, x=0.68,  y=0.9, gp=gpar(col="black", fontsize=7, fontface="bold"))
year3=Baseflow_monthly[i,2]

Time_Baseflow10<-Time_Baseflow5+geom_line(aes(x=date,y=Baseflow_monthly$sm),colour="black")
Time_Baseflow11<-Time_Baseflow10+ggtitle("Annual")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+ 
  geom_vline(aes(xintercept = year3),size = 0.7,color= "black",linetype="dashed")+
  annotation_custom(my_grob, xmin = as.Date(max(year3,100)), xmax = as.Date(max(year3,100)), ymin =max(Baseflow_monthly$sum_baseflow), ymax = max(Baseflow_monthly$sum_baseflow))
Time_Baseflow11
###################################
################################### ECP
#### ENERGY AGGLOMERATIVE
Baseflow_annuall<-Baseflow_yearly %>% dplyr::select(1)
Baseflow_annuall<- as.matrix(Baseflow_annuall)
x5= rep(c(min(Baseflow_yearly$Year):max(Baseflow_yearly$Year)), times= c(1))
##################################### member function
n=length(Baseflow_yearly$date)
num=1
mem <- vector()

while (n>11) {
  
  x= rep(c(num), times= c(11))
  
  n=n-11
  
  num=num+1
  
  mem <- append(mem, x)
  
}

x= rep(c(num), times= c(n))

mem <- append(mem, x)

print(mem)

##################  e.agglo CHANGE POINT DETECTION (ecp) TEST
CP_Baseflow= e.agglo(Baseflow_annuall,member=mem,alpha=2,penalty=function(cp,Xts) 0)
par(mfrow=c(1,1))
tiff(paste0(" ECP change point for annuall Baseflow ",".tiff"),width=1500, height=1000, res = 300)
CP_Baseflow$progression
plot(x5,CP_Baseflow$cluster,
     main="ECP test annual Baseflow",
     xlab = "Year",
     ylab="cluster",
     type="p",
     col="blue")
dev.off()
###############################
####################### Orginal MK test for annual data of baseflow
##view(Baseflow_yearly)
annuall_baseflow<-Baseflow_yearly
annuall_baseflow$yearfraction<-(annuall_baseflow$Year+0.110)
TR_annual_baseflow<-rkt(annuall_baseflow$yearfraction,annuall_baseflow$sum_baseflow)
print(TR_annual_baseflow)
capture.output(summary(print(TR_annual_baseflow)), file = " Annual Baseflow MK test results.txt")
TR_annual_baseflow$sl
TR_annual_baseflow$B
b0<- median(annuall_baseflow$sum_baseflow)-(TR_annual_baseflow$B * median(annuall_baseflow$Year))
annuall_baseflow$overall_slope<- b0+(TR_annual_baseflow$B * annuall_baseflow$Year)
a1<-as.character(annuall_baseflow$Year[1]) 
b1<-as.character(annuall_baseflow$Year[length(annuall_baseflow$Year)]) 
z1<-as.character(lapply(TR_annual_baseflow$B, round,2))
annuall_baseflow$`Sens Slope`<- paste("a)",a1,"-",b1,":"," ",z1," ","GL/yr",sep='')
################################################## MKLTP tEST FOR ANNUALL annuall_baseflow
annuall_baseflow$MKLTP.Sig<-as.numeric (NA)
annuall_baseflow$Mean<-as.numeric (NA)
annuall_baseflow$Line<-as.numeric (NA)
annuall_baseflow$overll_line<-as.numeric (annuall_baseflow$overall_slope)
annuall_baseflow$Line.pvalue<-as.character(NA)
annuall_baseflow$Mid_date<-as.Date.numeric(NA)
annuall_baseflow$mLine<- as.numeric(NA)
######################################
annuall_baseflow$Max_date<- as.Date.numeric(NA) 
annuall_baseflow$ECP<-as.character(NA) 
annuall_baseflow$Seq_p.value<-as.numeric (NA)
annuall_baseflow$MKLTP_p.value<-as.numeric (NA)
#######################################
myts_Annuall<- ts(annuall_baseflow$sum_baseflow, start=c(min(annuall_baseflow$Year)), end=c(max(annuall_baseflow$Year)), frequency=1)
MKLTP_Annuall_Baseflow<- MannKendallLTP(myts_Annuall)
capture.output(summary(print(MKLTP_Annuall_Baseflow)), file = " MKLTP annual Baseflow.txt")
annuall_baseflow$MKLTP.Sig<- if (MKLTP_Annuall_Baseflow$Mann_Kendall_LTP[2]>0.01){
  paste(lapply(MKLTP_Annuall_Baseflow$Mann_Kendall_LTP[2], round,2))} else {0.001}
annuall_baseflow$Line.pvalue<-if (annuall_baseflow$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",annuall_baseflow$MKLTP.Sig,")", sep = "")} else{NA}
annuall_baseflow$Mid_date<-min(annuall_baseflow$date)
############################
annuall_baseflow$Seq<-as.numeric(CP_Baseflow$cluster) 
ddddddddd<-as.numeric( which(CP_Baseflow$cluster == max(CP_Baseflow$cluster)))
annuall_baseflow$Seq[max(ddddddddd)+1]
jj<-max(ddddddddd)
JJJ<-as.numeric( length(annuall_baseflow$Seq))
annuall_baseflow$Seq[max(ddddddddd)+1]
i=annuall_baseflow$Seq[max(ddddddddd)+1]
annuall_baseflow$Seq[jj:JJJ]<- 
  if(i < as.numeric(annuall_baseflow$Seq[max(ddddddddd)])) {as.numeric(max(CP_Baseflow$cluster)+1)} else{annuall_baseflow$Seq}

################# SUBSET THE DATA BASED ON ecp
#for (i in annuall_baseflow$Seq){  
# m<- assign(paste("segment_", i, sep = "_"),subset(annuall_baseflow, Seq==i))}
######################################
Max_Seq_annuall<-max(annuall_baseflow$Seq)
NNNNN<-plyr::ddply(annuall_baseflow, plyr::.(Seq), function(m){
  FD<-rkt(m$yearfraction,m$sum_baseflow )
  capture.output(summary(print(FD)), file = " annuall_baseflow MK test results for segments.txt")
  b0<- median(m$sum_baseflow )-(FD$B* median(m$Year))
  m$overall_slope<- b0+(FD$B*m$Year)
  a3<-as.character(m$Year[1]) 
  b3<-as.character(m$Year[length(m$Year)]) 
  z3<-as.character(lapply(FD$B, round,2))
  m$`Sens Slope`<- paste( (if (m$Seq==1){"b)"} else if (m$Seq==2){"c)"} else if (m$Seq==3){"d)"} else if (m$Seq==4){"e)"} else if  (m$Seq==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","GL/yr",sep='')
  m$Max_date<- if (m$Seq< Max_Seq_annuall){as.Date(max(m$date))} else {as.Date.numeric(NA)}
  m$ECP<- if (m$Seq< Max_Seq_annuall){paste("ECP", m$Seq, sep = "")} else {as.character (NA)}
  m$Seq_p.value<- paste(lapply(FD$sl, round,2))
  ###################################
  myts_Annuall<- ts(m$sum_baseflow , start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
  MKLTP_Annuall_Baseflow<- MannKendallLTP(myts_Annuall)
  m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Annuall_Baseflow$Mann_Kendall_LTP[2], round,2),")", sep = "")
  #########################
  m$Mid_date<- min(m$date)
  m$Mean<-as.numeric (mean(m$sum_baseflow ))
  m$MKLTP.Sig<- if (MKLTP_Annuall_Baseflow$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Annuall_Baseflow$Mann_Kendall_LTP[2], round,2))} else {0.001}
  m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
  m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
  m$overll_line<-as.numeric (NA)
  m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
  ########
  return(m)
}
)
##view(NNNNN)
#####################################################################################
total_baseflow_annuall <- rbind(annuall_baseflow,NNNNN)
###view(total_baseflow_annuall)
tiff(paste0(" Annual baseflow_trend_change point ",".tiff"),width=2000, height=1500, res = 350)
annualbaseflowtrend1<-ggplot(total_baseflow_annuall, aes(x=date, color=`Sens Slope`))+
  geom_point(aes( y=sum_baseflow),size=1)+
  ggtitle("Annuall Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+
  xlab("Date")+ylab("Baseflow (GL/yr)")

annualbaseflowtrend2<-annualbaseflowtrend1+geom_line(aes(y=overll_line),size=0.8,
                                                     linetype= if(total_baseflow_annuall$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )

annualbaseflowtrend2<-annualbaseflowtrend2+geom_line(aes(y=Line),size=0.8,linetype="twodash")

annualbaseflowtrend3<-annualbaseflowtrend2+geom_line(aes(y=mLine),size=0.8,
                                                     linetype= if(total_baseflow_annuall$MKLTP.Sig<= 0.05){"twodash"} else {"solid"})
################################
for (i in total_baseflow_annuall$Max_date){
  annualbaseflowtrend3  <- annualbaseflowtrend3+ 
    geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
}

annualbaseflowtrend4<-annualbaseflowtrend3+geom_text(mapping = aes(x = Max_date,
                                                                   y = max(sum_baseflow),
                                                                   label = ECP,
                                                                   hjust = 1.5,
                                                                   vjust = 1.5),
                                                     size=3,
                                                     angle=90,
                                                     show.legend = FALSE,
                                                     data = total_baseflow_annuall)

annualbaseflowtrend4<- annualbaseflowtrend4+geom_text(mapping = aes(x = Mid_date,
                                                                    y = max(sum_baseflow),
                                                                    fill=`Sens Slope`,
                                                                    label = Line.pvalue,
                                                                    hjust =1,
                                                                    vjust = 5.5),
                                                      size=2.5,
                                                      angle=90,
                                                      show.legend = FALSE,
                                                      data = total_baseflow_annuall)
annualbaseflowtrend4
dev.off()
#####################
#################### A divisive hierarchical estimation algorithm for multiple change point analysis
################### e.divisive ENERGY DIVISIVE for annuall data
for(i in 1:5){
  ED_Annuall_baseflow=e.divisive(X=Baseflow_annuall,sig.lvl=0.05,R=199,k=NULL,min.size=10,alpha=1)
  if(ED_Annuall_baseflow$p.values[1]<=0.05) {
    print("End of Loop") ;
    break
  } else{"KHHHH"}
  
}
#######################
annuall_baseflow
if (max(ED_Annuall_baseflow$cluster)<2){capture.output(print("No change point"), file = " EDP No Change point for annuall baseflow.txt")} else{
  annuall_baseflow_ED<-annuall_baseflow %>% dplyr::select(1:8)
  annuall_baseflow_ED$Seq_ED<-as.numeric(ED_Annuall_baseflow$cluster)
  ####################
  #################### MKLTP
  annuall_baseflow_ED$MKLTP.Sig<-as.numeric (NA)
  annuall_baseflow_ED$Mean<-as.numeric (NA)
  annuall_baseflow_ED$Line<-as.numeric (NA)
  annuall_baseflow_ED$overll_line<-as.numeric (annuall_baseflow_ED$overall_slope)
  annuall_baseflow_ED$Line.pvalue<-as.character(NA)
  annuall_baseflow_ED$mLine<- as.numeric(NA)
  #####################################
  annuall_baseflow_ED$Max_date_ED<- as.Date.numeric(NA) 
  annuall_baseflow_ED$EDP<-as.character(NA) 
  annuall_baseflow_ED$p.value<-as.numeric (NA)
  annuall_baseflow_ED$Seq_p.value<-as.numeric (NA)
  annuall_baseflow_ED$MKLTP_p.value<-as.numeric (NA)
  annuall_baseflow_ED$Mid_date_ED<-as.Date.numeric(NA)
  #####################################
  myts_Annuall_ED<- ts(annuall_baseflow_ED$sum_baseflow, start=c(min(annuall_baseflow_ED$Year)), end=c(max(annuall_baseflow_ED$Year)), frequency=1)
  MKLTP_Annuall_Baseflow_ED<- MannKendallLTP(myts_Annuall_ED)
  capture.output(summary(print(MKLTP_Annuall_Baseflow_ED)), file = " MKLTP annual Baseflow_ED.txt")
  annuall_baseflow_ED$MKLTP.Sig<- if (MKLTP_Annuall_Baseflow_ED$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Annuall_Baseflow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
  annuall_baseflow_ED$Line.pvalue<-if (annuall_baseflow_ED$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",annuall_baseflow_ED$MKLTP.Sig,")", sep = "")} else{NA}
  annuall_baseflow_ED$Mid_date_ED<-min(annuall_baseflow_ED$date)
  ####
  ddddddddd<-as.numeric( which(ED_Annuall_baseflow$cluster == max(ED_Annuall_baseflow$cluster)))
  max(ddddddddd)
  str(ddddddddd)
  annuall_baseflow_ED$Seq_ED[max(ddddddddd)+1]
  jj<-max(ddddddddd)
  JJJ<-as.numeric( length(annuall_baseflow_ED$Seq_ED))
  annuall_baseflow_ED$Seq_ED[max(ddddddddd)+1]
  i=annuall_baseflow_ED$Seq_ED[max(ddddddddd)+1]
  ##################
  
  #for (i in annuall_baseflow_ED$Seq){  
  # m<- assign(paste("segment_", i, sep = "_"),subset(annuall_baseflow_ED, Seq==i))}
  
  ######################################
  Max_Seq_ED_Annuall_baseflow<-max(annuall_baseflow_ED$Seq_ED)
  EDPP<-plyr::ddply(annuall_baseflow_ED, plyr::.(Seq_ED), function(m){
    FD<-rkt(m$yearfraction,m$sum_baseflow)
    FD$B
    b0<- median(m$sum_baseflow)-(FD$B* median(m$Year))
    m$overall_slope<- b0+(FD$B*m$Year)
    length(m$Year)
    a3<-as.character(m$Year[1]) 
    b3<-as.character(m$Year[length(m$Year)]) 
    z3<-as.character(lapply(FD$B, round,2))
    m$`Sens Slope`<- paste( (if (m$Seq_ED==1){"b)"} else if (m$Seq_ED==2){"c)"} else if (m$Seq_ED==3){"d)"} else if (m$Seq_ED==4){"e)"} else if  (m$Seq_ED==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","GL/yr",sep='')
    m$Max_date_ED<- if (m$Seq_ED< Max_Seq_ED_Annuall_baseflow){as.Date(max(m$date))} else {as.Date.numeric(NA)}
    m$p.value<- ED_Annuall_baseflow$p.values[m$Seq_ED]
    m$EDP<- if (m$Seq_ED< Max_Seq_ED_Annuall_baseflow){paste("EDP", m$Seq_ED," ","p","(",m$p.value,")", sep = "")} else {as.character (NA)}
    m$Seq_p.value<- paste(lapply(FD$sl, round,2))
    m$Mid_date_ED<- median(m$date)
    #######
    myts_ED_annual <- ts(m$sum_baseflow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
    MKLTP_Annuall_Baseflow_ED<- MannKendallLTP( myts_ED_annual)
    m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Annuall_Baseflow_ED$Mann_Kendall_LTP[2], round,2),")", sep = "")
    #########################
    m$Mid_date_ED<- min(m$date)
    m$Mean<-as.numeric (mean(m$sum_baseflow))
    m$MKLTP.Sig<- if (MKLTP_Annuall_Baseflow_ED$Mann_Kendall_LTP[2]>0.01){
      paste(lapply(MKLTP_Annuall_Baseflow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
    m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
    m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
    m$overll_line<-as.numeric (NA)
    m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
    #######################
    return(m)
  }
  )
  
  #####################################################################################
  total_baseflow_annuall_EDP <- rbind(annuall_baseflow_ED,EDPP)
  
  tiff(paste0(" Annuall baseflow_trend_ EDP change point ",".tiff"),width=2000, height=1500, res = 350)
  annual_baseflowtrend_EDP1<-ggplot( total_baseflow_annuall_EDP, aes(x=date,color=`Sens Slope`))+
    geom_point(aes( y=sum_baseflow),size=1) +xlab("Date")+ylab("Baseflow (GL/yr)")+
    ggtitle("Annuall Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))
  annual_baseflowtrend_EDP2<-annual_baseflowtrend_EDP1+ geom_line(aes(y=overll_line),size=0.8,
                                                                  linetype= if( total_baseflow_annuall_EDP$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )
  annual_baseflowtrend_EDP3<-annual_baseflowtrend_EDP2+geom_line(aes(y=Line),size=0.8,linetype="twodash")
  annual_baseflowtrend_EDP4<-annual_baseflowtrend_EDP3+geom_line(aes(y=mLine),size=0.8,
                                                                 linetype= if( total_baseflow_annuall_EDP$MKLTP.Sig<= 0.05){"twodash"} else {"solid"})
  #########
  
  for (i in  total_baseflow_annuall_EDP$Max_date_ED){
    annual_baseflowtrend_EDP4  <- annual_baseflowtrend_EDP4+ 
      geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
  }
  
  annual_baseflowtrend_EDP4<-annual_baseflowtrend_EDP4+geom_text(mapping = aes(x = Max_date_ED,
                                                                               y = max(sum_baseflow),
                                                                               label = EDP,
                                                                               hjust = 1.5,
                                                                               vjust = 1.5),
                                                                 size=3,
                                                                 angle=90,
                                                                 show.legend = FALSE,
                                                                 data =  total_baseflow_annuall_EDP)
  
  annual_baseflowtrend_EDP4<- annual_baseflowtrend_EDP4+geom_text(mapping = aes(x = Mid_date_ED,
                                                                                y = max(sum_baseflow),
                                                                                label = Line.pvalue,
                                                                                hjust =1,
                                                                                vjust = 5.5),
                                                                  size=2.5,
                                                                  angle=90,
                                                                  show.legend = FALSE,
                                                                  data =  total_baseflow_annuall_EDP)
  annual_baseflowtrend_EDP4
}# end of if
dev.off()
######################################
############################ WET and DRY SEASON for baseflow
############################ SEASONAL SMK TEST
##view(Baseflow_season)
Baseflow_season<- Baseflow_season %>%
  mutate(season = case_when(
    Month %in% 5:10 ~ "Wet",
    Month %in%  11:12  ~ "Dry",
    Month %in%  1:4  ~ "Dry"))
Baseflow_wetseason <- subset(Baseflow_season, season %in% c("Wet"))
Baseflow_dryseason <- subset(Baseflow_season, season %in% c("Dry"))
#####################
##################### SMK test for  Baseflow in wet and dry season
Tr_Baseflow_Dryseason<-rkt(Baseflow_dryseason$Year,Baseflow_dryseason$sum_baseflow,Baseflow_dryseason$Month,,TRUE)
print(Tr_Baseflow_Dryseason)
capture.output(summary(print(Tr_Baseflow_Dryseason)), file = "Baseflow_Dryseason SMK test results.txt")

Tr_Baseflow_Wetseason<-rkt(Baseflow_wetseason$Year,Baseflow_wetseason$sum_baseflow,Baseflow_wetseason$Month,,TRUE)
print(Tr_Baseflow_Wetseason)
capture.output(summary(print(Tr_Baseflow_Wetseason)), file = "Baseflow_wetseason SMK test results.txt")
############################
######################## cahange point detectionLanzanteâs Change point test
###################### dry season for baseflow, these data are monthly
tiff(paste0(" Baseflow_dryseason_Lanzanteâs Change point ",".tiff"),width=1500, height=1000, res = 300)
par(mfrow=c(1,1))
plot(Baseflow_dryseason$Year,Baseflow_dryseason$sum_baseflow)
s.res <- lanzante.test(Baseflow_dryseason$sum_baseflow)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean( Baseflow_dryseason$sum_baseflow[1:i])
s.2 <- mean(Baseflow_dryseason$sum_baseflow[(i+1):n])
s <-(c(rep(s.1,i), rep(s.2,(n-i))))
lines(Baseflow_dryseason$Year, s, col=2,lty=1)
print(s.res)
dev.off()
################################## WET season for base flow these data are monthly
tiff(paste0(" Baseflow_wetseason_Lanzanteâs Change point ",".tiff"),width=1500, height=1000, res = 300)
par(mfrow=c(1,1))
plot(Baseflow_wetseason$Year,Baseflow_wetseason$sum_baseflow)
s.res <- lanzante.test(Baseflow_wetseason$sum_baseflow)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean( Baseflow_wetseason$sum_baseflow[1:i])
s.2 <- mean(Baseflow_wetseason$sum_baseflow[(i+1):n])
s <-(c(rep(s.1,i), rep(s.2,(n-i))))
lines(Baseflow_wetseason$Year, s, col=2,lty=1)
print(s.res)
dev.off()
##################################### CDFM
Baseflow_wetseason
Baseflow_dryseason
Mean_dry<- mean(Baseflow_dryseason$sum_baseflow)
Baseflow_dryseason$pi_dry=((Baseflow_dryseason$sum_baseflow-Mean_dry)/6)
Baseflow_dryseason$CDFM_dry<- cumsum(Baseflow_dryseason$pi_dry) # replace the cell freq.s by cumulative freq.s
## wet
Mean_wet<- mean(Baseflow_wetseason$sum_baseflow)
Baseflow_wetseason$pi_wet=((Baseflow_wetseason$sum_baseflow-Mean_wet)/6)
Baseflow_wetseason$CDFM_wet<- cumsum(Baseflow_wetseason$pi_wet) 
###############  dry monthly lAN TEST
s.res <- lanzante.test(Baseflow_dryseason$sum_baseflow)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean( Baseflow_dryseason$sum_baseflow[1:i])
s.2 <- mean(Baseflow_dryseason$sum_baseflow[(i+1):n])
sd <-(c(rep(s.1,i), rep(s.2,(n-i))))
sd<-as.data.frame(as.numeric(sd))
Baseflow_dryseason$sd<-sd$`as.numeric(sd)`
p_value <- s.res$p.value
str(p_value)
hhh<- if(p_value > 0.05){print("LAT (p>0.05)")} else if(p_value > 0.01 & p_value < 0.05){print("LAT (p<0.05)")} else{print("LAT (p<0.01)")}
my_text1 <- hhh
my_grob1 = grid.text(my_text1, gp=gpar(col="black", fontsize=7, fontface="bold"))
year4=Baseflow_dryseason[i,2]
lims<- c(min= as.Date(min(Baseflow_dryseason$date)), max= as.Date(max(Baseflow_dryseason$date)))
time_baseflowdry<-ggplot(Baseflow_dryseason)+geom_line( aes(x=date, y=sum_baseflow),color= "grey")
time_baseflowdry1<-time_baseflowdry+geom_line(aes(x=date, y=CDFM_dry),alpha = 0.6, size = 0.7,color= "blue")
time_baseflowdry2<-time_baseflowdry1+geom_smooth(aes(x=date, y=CDFM_dry),method="gam",color="red")+xlab("Date")+ylab("Baseflow (GL/month)")
time_baseflowdry3<-time_baseflowdry2+scale_y_continuous(sec.axis = sec_axis(name ="CDFM (GL)",~ . + 0))
time_baseflowdry4<-time_baseflowdry3+geom_vline(aes(xintercept = year4),size = 0.7,color= "black",linetype="dashed")
time_baseflowdry5<-time_baseflowdry4+geom_line(aes(x=date,y=sd),color= "black")+ggtitle("Dry Seasons")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+
  annotation_custom(my_grob1, xmin = as.Date(max(year4,100)), xmax = as.Date(max(year4,100)), ymin =max(Baseflow_dryseason$sum_baseflow), ymax = max(Baseflow_dryseason$sum_baseflow))
time_baseflowdry5
dev.off()
##############
############## Wet SEASON lanzante TEST
s.res <- lanzante.test(Baseflow_wetseason$sum_baseflow)
n <- s.res$nobs
i <- s.res$estimate
s.1 <- mean( Baseflow_wetseason$sum_baseflow[1:i])
s.2 <- mean(Baseflow_wetseason$sum_baseflow[(i+1):n])
sw<-(c(rep(s.1,i), rep(s.2,(n-i))))
sw<-as.data.frame(as.numeric(sw))
Baseflow_wetseason$sw<-sw$`as.numeric(sw)`
p_value <- s.res$p.value
str(p_value)
hhhh<- if(p_value > 0.05){print("LAT (p>0.05)")} else if(p_value > 0.01 & p_value < 0.05){print("LAT (p<0.05)")} else{print("LAT (p<0.01)")}
my_text2 <- hhhh
my_grob2 = grid.text(my_text2, gp=gpar(col="black", fontsize=7, fontface="bold"))
year5=Baseflow_wetseason[i,2]
lims<- c(min= as.Date(min(Baseflow_wetseason$date)), max= as.Date(max(Baseflow_wetseason$date)))
####### pLOTTING CDFM
time_baseflowwet<-ggplot(Baseflow_wetseason)+geom_line( aes(x=date, y=sum_baseflow),color= "grey")
timee_wet1<-time_baseflowwet+geom_line(aes(x=date, y=CDFM_wet),alpha = 0.6, size = 0.7,color= "blue")
time_baseflowwet2<-timee_wet1+geom_smooth(aes(x=date, y=CDFM_wet),method="gam",color="red")+xlab("Date")+ylab("Baseflow (GL/month)")
time_baseflowwet3<-time_baseflowwet2+scale_y_continuous(sec.axis = sec_axis(name ="CDFM (GL)",~ . + 0))
time_baseflowwet4<-time_baseflowwet3+geom_vline(aes(xintercept = year5),size = 0.7,color= "black",linetype="dashed")
time_baseflowwet5<-time_baseflowwet4+geom_line(aes(x=date,y=sw),color= "black")+ggtitle("Wet Seasons")+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+ 
  annotation_custom(my_grob2, xmin = as.Date(max(year5,100)), xmax = as.Date(max(year5,100)), ymin =max(Baseflow_wetseason$sum_baseflow), ymax = max(Baseflow_wetseason$sum_baseflow))
time_baseflowwet5
####################################################################### ALL CDFM PLOTS
tiff(paste0("CDFM_Baseflow ",".tiff"),width=2000, height=2500, res = 350)
p<-ggarrange(Time_Baseflow11,time_baseflowdry5,time_baseflowwet5, nrow =3, ncol =1, heights = c(10, 10,10),
             widths =c(0.5) )
dev.off()

##################################
ts_wet_baseflow <- xts(Baseflow_wetseason$sum_baseflow, as.Date(Baseflow_wetseason$date, "%Y-%m-%d"))
ts_dry_baseflow <- xts(Baseflow_dryseason$sum_baseflow, as.Date(Baseflow_dryseason$date, "%Y-%m-%d"))
# convert daily data to annual and monthly
ts_y_baseflow_wet = apply.yearly(ts_wet_baseflow, sum)
ts_y_baseflow_dry = apply.yearly(ts_dry_baseflow, sum)
##ts_q = apply.quarterly(ts, sum)
ts_wet_bf=data.frame(sum_baseflow=coredata(ts_y_baseflow_wet),date=index(ts_y_baseflow_wet))
ts_dry_bf=data.frame(sum_baseflow=coredata(ts_y_baseflow_dry),date=index(ts_y_baseflow_dry))
Baseflow_wet_annuall= ts_wet_bf %>% 
  mutate(date = ymd(date)) %>% 
  mutate_at(vars(date), funs(year, month, day))
Baseflow_dry_annuall= ts_dry_bf %>% 
  mutate(date = ymd(date)) %>% 
  mutate_at(vars(date), funs(year, month, day))
colnames(Baseflow_wet_annuall) <- c("sum_baseflow","date","Year","Month","Day")
colnames(Baseflow_dry_annuall) <- c("sum_baseflow","date","Year","Month","Day")
####
Baseflow_wet_annuall$yearfraction<-(Baseflow_wet_annuall$Year+0.110)
Baseflow_dry_annuall$yearfraction<-(Baseflow_dry_annuall$Year+0.110)
########################
Baseflow_dryseason
#####################################ECP change point wet season
Baseflow_Wet<-Baseflow_wet_annuall %>% dplyr::select(1)
Baseflow_Wet<- as.matrix(Baseflow_Wet)
x6= rep(c(min(Baseflow_wet_annuall$Year):max(Baseflow_wet_annuall$Year)), times= c(1))
##################################### mem
n1=length(Baseflow_wet_annuall$date)
num=1
mem1 <- vector()

while (n1>11) {
  
  x= rep(c(num), times= c(11))
  
  n1=n1-11
  
  num=num+1
  
  mem1 <- append(mem1, x)
  
}

x= rep(c(num), times= c(n1))

mem1 <- append(mem1, x)

print(mem1)

#### mem= rep=shows possible number of change point and time should the same as x= length
CP_Baseflow_wet= e.agglo(Baseflow_Wet,member=mem1,alpha=2,penalty=function(cp,Xts) 0)
par(mfrow=c(1,1))
tiff(paste0(" ECP change point for annual wet baseflow ",".tiff"),width=1500, height=1000, res = 300)
CP_Baseflow_wet$progression
#plot(CP_Baseflow_wet$cluster)
plot(x6, CP_Baseflow_wet$cluster,
     main="ECP test annual wet baseflow",
     xlab = "Year",
     ylab="cluster",
     type="p",
     col="blue")
dev.off()

########################################## orginal MK test for Baseflow_wet_annuall
TR_wet_baseflow<-rkt(Baseflow_wet_annuall$yearfraction,Baseflow_wet_annuall$sum_baseflow)
print(TR_wet_baseflow)
capture.output(summary(print(TR_wet_baseflow)), file = " Baseflow_annual_wet MK test results.txt")
TR_wet_baseflow$B
b0<- median(Baseflow_wet_annuall$sum_baseflow)-(TR_wet_baseflow$B * median(Baseflow_wet_annuall$Year))
Baseflow_wet_annuall$overall_slope<- b0+(TR_wet_baseflow$B * Baseflow_wet_annuall$Year)
length(Baseflow_wet_annuall$Year)
a2<-as.character(Baseflow_wet_annuall$Year[1]) 
b2<-as.character(Baseflow_wet_annuall$Year[length(Baseflow_wet_annuall$Year)]) 
z2<-as.character(lapply(TR_wet_baseflow$B, round,2))
Baseflow_wet_annuall$`Sens Slope`<- paste("a)",a2,"-",b2,":"," ",z2," ","GL/yr",sep='')

################################################## MKLTP
Baseflow_wet_annuall$MKLTP.Sig<-as.numeric (NA)
Baseflow_wet_annuall$Mean<-as.numeric (NA)
Baseflow_wet_annuall$Line<-as.numeric (NA)
Baseflow_wet_annuall$overll_line<-as.numeric (Baseflow_wet_annuall$overall_slope)
Baseflow_wet_annuall$Line.pvalue<-as.character(NA)
Baseflow_wet_annuall$Mid_date<-as.Date.numeric(NA)
Baseflow_wet_annuall$mLine<- as.numeric (NA)
#######################
myts_Wet<- ts(Baseflow_wet_annuall$sum_baseflow, start=c(min(Baseflow_wet_annuall$Year)),
              end=c(max(Baseflow_wet_annuall$Year)), frequency=1)
MKLTP_Wet_Baseflow<- MannKendallLTP(myts_Wet)
capture.output(summary(print(MKLTP_Wet_Baseflow)), file = " MKLTP annual Baseflow_WET.txt")
Baseflow_wet_annuall$MKLTP.Sig<- if (MKLTP_Wet_Baseflow$Mann_Kendall_LTP[2]>0.01){
  paste(lapply(MKLTP_Wet_Baseflow$Mann_Kendall_LTP[2], round,2))} else {0.001}
Baseflow_wet_annuall$Line.pvalue<-if (Baseflow_wet_annuall$MKLTP.Sig<=0.05){paste("MKLTP", " ","p","(",Baseflow_wet_annuall$MKLTP.Sig,")", sep = "")} else{NA}
Baseflow_wet_annuall$Mid_date<-min(Baseflow_wet_annuall$date)
############################
Baseflow_wet_annuall$Seq<-as.numeric(CP_Baseflow_wet$cluster) 
ddddddddd<-as.numeric( which(CP_Baseflow_wet$cluster == max(CP_Baseflow_wet$cluster)))
Baseflow_wet_annuall$Seq[max(ddddddddd)+1]
jj<-max(ddddddddd)
JJJ<-as.numeric( length(Baseflow_wet_annuall$Seq))
Baseflow_wet_annuall$Seq[max(ddddddddd)+1]
i=Baseflow_wet_annuall$Seq[max(ddddddddd)+1]
Baseflow_wet_annuall$Seq[jj:JJJ]<- 
  if(i < as.numeric(Baseflow_wet_annuall$Seq[max(ddddddddd)])) {as.numeric(max(CP_Baseflow_wet$cluster)+1)} else{Baseflow_wet_annuall$Seq}
###view(Baseflow_wet_annuall)
Baseflow_wet_annuall$Max_date<- as.Date.numeric(NA) 
Baseflow_wet_annuall$ECP<-as.character(NA) 
Baseflow_wet_annuall$Seq_p.value<-as.numeric (NA)
Baseflow_wet_annuall$MKLTP_p.value<-as.numeric (NA)
max(Baseflow_wet_annuall$Seq)
#################
#for (i in Baseflow_wet_annuall$Seq){  
# m<- assign(paste("segment_wet", i, sep = "_"),subset(Baseflow_wet_annuall, Seq==i))}
######################################
Max_Seq_wet<-max(Baseflow_wet_annuall$Seq)
SSSSS<-plyr::ddply(Baseflow_wet_annuall, plyr::.(Seq), function(m){
  FD<-rkt(m$yearfraction,m$sum_baseflow)
  b0<- median(m$sum_baseflow)-(FD$B* median(m$Year))
  m$overall_slope<- b0+(FD$B*m$Year)
  length(m$Year)
  a3<-as.character(m$Year[1]) 
  b3<-as.character(m$Year[length(m$Year)]) 
  z3<-as.character(lapply(FD$B, round,2))
  m$`Sens Slope`<- paste( (if (m$Seq==1){"b)"} else if (m$Seq==2){"c)"} else if (m$Seq==3){"d)"} else if (m$Seq==4){"e)"} else if  (m$Seq==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","GL/yr",sep='')
  m$Max_date<- if (m$Seq< Max_Seq_wet){as.Date(max(m$date))} else {as.Date.numeric(NA)}
  m$ECP<- if (m$Seq< Max_Seq_wet){paste("ECP", m$Seq, sep = "")} else {as.character (NA)}
  m$Seq_p.value<- paste(lapply(FD$sl, round,2))
  #############
  myts_Wet <- ts(m$sum_baseflow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
  MKLTP_Wet_Baseflow<- MannKendallLTP(myts_Wet)
  m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Wet_Baseflow$Mann_Kendall_LTP[2], round,2),")", sep = "")
  ############################
  m$Mid_date<- min(m$date)
  m$Mean<-as.numeric (mean(m$sum_baseflow))
  m$MKLTP.Sig<- if (MKLTP_Wet_Baseflow$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Wet_Baseflow$Mann_Kendall_LTP[2], round,2))} else {0.001}
  m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
  m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
  m$overll_line<-as.numeric (NA)
  m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
  #################
  print(m$ECP)
  return(m)
}
)
##view(SSSSS)
#########
###############################
total_baseflow_wet<- rbind(Baseflow_wet_annuall,SSSSS)
##view(total_baseflow_wet)
tiff(paste0(" Annual baseflow wet_trend_change point ",".tiff"),width=2000, height=1500, res = 350)
Wet_baseflowtrend1<-ggplot(total_baseflow_wet, aes(x=date, color=`Sens Slope`))+
  geom_point(aes(y=sum_baseflow , color=`Sens Slope`),size=1)+
  ggtitle("Wet Seasons Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+
  xlab("Date")+ylab("Baseflow (GL/year)")
Wet_baseflowtrend2<-Wet_baseflowtrend1+geom_line(aes(y=overll_line),size=0.8,
                                                 linetype= if(total_baseflow_wet$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )
Wet_baseflowtrend3<-Wet_baseflowtrend2+geom_line(aes(y=Line),size=0.8,linetype="twodash")
Wet_baseflowtrend4<-Wet_baseflowtrend3+geom_line(aes(y=mLine),size=0.8,
                                                 linetype= if(total_baseflow_wet$MKLTP.Sig<= 0.05){"twodash"} else {"solid"})                                         

#################
for (i in total_baseflow_wet$Max_date){
  Wet_baseflowtrend4  <- Wet_baseflowtrend4+ 
    geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
}

Wet_baseflowtrend4<-Wet_baseflowtrend4+geom_text(mapping = aes(x = Max_date,
                                                               y = max(sum_baseflow ),
                                                               label = ECP,
                                                               hjust = 1.5,
                                                               vjust = 1.5),
                                                 size=2.5,
                                                 angle=90,
                                                 show.legend = FALSE,
                                                 data = total_baseflow_wet)

Wet_baseflowtrend4<-Wet_baseflowtrend4+geom_text(mapping = aes(x=Mid_date,
                                                               y = max(sum_baseflow ),
                                                               fill=`Sens Slope`,
                                                               label = Line.pvalue,
                                                               hjust = 1,
                                                               vjust = 3),
                                                 size=2.5,
                                                 angle=90,
                                                 show.legend = FALSE,
                                                 data = total_baseflow_wet)

Wet_baseflowtrend4
dev.off()
#################
################### A divisive hierarchical estimation algorithm for multiple change point analysis
################### e.divisive ENERGY DIVISIVE for annuall data
Baseflow_Wet
for(i in 1:5){
  ED_Wet_baseflow=e.divisive(X=Baseflow_Wet,sig.lvl=0.05,R=199,k=NULL,min.size=10,alpha=1)
  if(ED_Wet_baseflow$p.values[1]<=0.05) {
    print("End of Loop") ;
    break
  } else{"KHHHH"}
  
}

if (max(ED_Wet_baseflow$cluster)<2){capture.output(print("No change point"), file = " EDP No Change point for wet season basflow.txt")} else{
  baseflow_ED_Wet<-Baseflow_wet_annuall %>% dplyr::select(1:8)
  baseflow_ED_Wet$Seq_ED<-as.numeric(ED_Wet_baseflow$cluster) 
  ########################################
  ##view( baseflow_ED_Wet)
  ################################################## MKLTP
  baseflow_ED_Wet$MKLTP.Sig<-as.numeric (NA)
  baseflow_ED_Wet$Mean<-as.numeric (NA)
  baseflow_ED_Wet$Line<-as.numeric (NA)
  baseflow_ED_Wet$overll_line<-as.numeric ( baseflow_ED_Wet$overall_slope)
  baseflow_ED_Wet$Line.pvalue<-as.character(NA)
  baseflow_ED_Wet$mLine<- as.numeric (NA)
  ########################
  baseflow_ED_Wet$Max_date_ED<- as.Date.numeric(NA) 
  baseflow_ED_Wet$EDP<-as.character(NA) 
  baseflow_ED_Wet$p.value<-as.numeric (NA)
  baseflow_ED_Wet$Seq_p.value<-as.numeric (NA)
  baseflow_ED_Wet$MKLTP_p.value<-as.numeric (NA)
  baseflow_ED_Wet$Mid_date_ED<-as.Date.numeric(NA)
  ###################################
  myts_Wet_ED<- ts( baseflow_ED_Wet$sum_baseflow, start=c(min( baseflow_ED_Wet$Year)), end=c(max( baseflow_ED_Wet$Year)), frequency=1)
  MKLTP_Wet_Baseflow_ED<- MannKendallLTP(myts_Wet_ED)
  capture.output(summary(print(MKLTP_Wet_Baseflow_ED)), file = " MKLTP annual Baseflow_WET_ED.txt")
  baseflow_ED_Wet$MKLTP.Sig<- if (MKLTP_Wet_Baseflow_ED$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Wet_Baseflow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
  baseflow_ED_Wet$Line.pvalue<-if ( baseflow_ED_Wet$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(", baseflow_ED_Wet$MKLTP.Sig,")", sep = "")} else{NA}
  baseflow_ED_Wet$Mid_date_ED<-min( baseflow_ED_Wet$date)
  ############################
  ###########################
  ddddddddd<-as.numeric( which(ED_Wet_baseflow$cluster == max(ED_Wet_baseflow$cluster)))
  baseflow_ED_Wet$Seq_ED[max(ddddddddd)+1]
  jj<-max(ddddddddd)
  JJJ<-as.numeric( length( baseflow_ED_Wet$Seq_ED))
  baseflow_ED_Wet$Seq_ED[max(ddddddddd)+1]
  i= baseflow_ED_Wet$Seq_ED[max(ddddddddd)+1]
  #################
  #for (i in  baseflow_ED_Wet$Seq){  
  # m<- assign(paste("segment_", i, sep = "_"),subset( baseflow_ED_Wet, Seq==i))}
  ######################################
  Max_Seq_ED_Wet<-max( baseflow_ED_Wet$Seq_ED)
  EDPP<-plyr::ddply( baseflow_ED_Wet, plyr::.(Seq_ED), function(m){
    FD<-rkt(m$yearfraction,m$sum_baseflow)
    b0<- median(m$sum_baseflow)-(FD$B* median(m$Year))
    m$overall_slope<- b0+(FD$B*m$Year)
    length(m$Year)
    a3<-as.character(m$Year[1]) 
    b3<-as.character(m$Year[length(m$Year)]) 
    z3<-as.character(lapply(FD$B, round,2))
    m$`Sens Slope`<- paste( (if (m$Seq_ED==1){"b)"} else if (m$Seq_ED==2){"c)"} else if (m$Seq_ED==3){"d)"} else if (m$Seq_ED==4){"e)"} else if  (m$Seq_ED==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","GL/yr",sep='')
    m$Max_date_ED<- if (m$Seq_ED< Max_Seq_ED_Wet){as.Date(max(m$date))} else {as.Date.numeric(NA)}
    m$p.value<- ED_Wet$p.values[m$Seq_ED]
    m$EDP<- if (m$Seq_ED< Max_Seq_ED_Wet){paste("EDP", m$Seq_ED," ","p","(",m$p.value,")", sep = "")} else {as.character (NA)}
    m$Seq_p.value<- paste(lapply(FD$sl, round,2))
    ######
    myts_Wet_ED <- ts(m$sum_baseflow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
    MKLTP_Wet_Baseflow_ED<- MannKendallLTP(myts_Wet_ED)
    m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Wet_Baseflow_ED$Mann_Kendall_LTP[2], round,2),")", sep = "")
    ########################
    m$Mid_date_ED<- min(m$date)
    m$Mean<-as.numeric (mean(m$sum_baseflow))
    m$MKLTP.Sig<- if (MKLTP_Wet_Baseflow_ED$Mann_Kendall_LTP[2]>0.01){
      paste(lapply(MKLTP_Wet_Baseflow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
    m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
    m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
    m$overll_line<-as.numeric (NA)
    m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
    #################
    return(m)
  }
  )
  
  #####################################################################################
  total_baseflow_Wet_EDP <- rbind( baseflow_ED_Wet,EDPP)
  ####
  tiff(paste0(" Wet baseflow_trend_EDP change point ",".tiff"),width=2000, height=1500, res = 350)
  Wet_baseflowtrend_EDP1<-ggplot(total_baseflow_Wet_EDP, aes(x=date, color=`Sens Slope`))+
    geom_point(aes(y=sum_baseflow, color=`Sens Slope`),size=1)+xlab("Date")+ylab("Baseflow (GL/yr)")+
    ggtitle("Wet Season Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))
  Wet_baseflowtrend_EDP2<-Wet_baseflowtrend_EDP1+geom_line(aes(y=overll_line),size=0.8,
                                                           linetype= if(total_baseflow_Wet_EDP$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )
  Wet_baseflowtrend_EDP3<-Wet_baseflowtrend_EDP2+geom_line(aes(y=Line),size=0.8,linetype="twodash")
  Wet_baseflowtrend_EDP4<-Wet_baseflowtrend_EDP3+ geom_line(aes(y=mLine),size=0.8,
                                                            linetype= if(total_baseflow_Wet_EDP$MKLTP.Sig<= 0.05){"twodash"} else {"solid"})                                         
  
  ##########
  
  for (i in total_baseflow_Wet_EDP$Max_date_ED){
    Wet_baseflowtrend_EDP4  <- Wet_baseflowtrend_EDP4+ 
      geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
  }
  
  Wet_baseflowtrend_EDP4<-Wet_baseflowtrend_EDP4+geom_text(mapping = aes(x = Max_date_ED,
                                                                         y = max(sum_baseflow),
                                                                         label = EDP,
                                                                         hjust = 1.5,
                                                                         vjust = 1.5),
                                                           size=3,
                                                           angle=90,
                                                           show.legend = FALSE,
                                                           data =total_baseflow_Wet_EDP)
  
  Wet_baseflowtrend_EDP4<-Wet_baseflowtrend_EDP4+geom_text(mapping = aes(x = Mid_date_ED,
                                                                         y = max(sum_baseflow),
                                                                         label = Line.pvalue,
                                                                         hjust = 1,
                                                                         vjust = 5.5), 
                                                           size=2.5,  
                                                           angle=90,
                                                           show.legend = FALSE,
                                                           data =total_baseflow_Wet_EDP)
  Wet_baseflowtrend_EDP4
  
}# end of if
dev.off()
##################
################### Dry season annuall baseflow
#####################################ECP change point wet season
Baseflow_Dry<-Baseflow_dry_annuall %>% dplyr::select(1)
Baseflow_Dry<- as.matrix(Baseflow_Dry)
x7= rep(c(min(Baseflow_dry_annuall$Year):max(Baseflow_dry_annuall$Year)), times= c(1))
##################################### mem
n1=length(Baseflow_dry_annuall$date)
num=1
mem1 <- vector()

while (n1>11) {
  
  x= rep(c(num), times= c(11))
  
  n1=n1-11
  
  num=num+1
  
  mem1 <- append(mem1, x)
  
}

x= rep(c(num), times= c(n1))

mem1 <- append(mem1, x)

print(mem1)

#### mem= rep=shows possible number of change point and time should the same as x= length
CP_Baseflow_dry= e.agglo(Baseflow_Dry,member=mem1,alpha=2,penalty=function(cp,Xts) 0)
par(mfrow=c(1,1))
tiff(paste0(" ECP change point for annual dry baseflow ",".tiff"),width=1500, height=1000, res = 300)
CP_Baseflow_dry$progression
#plot(CP_Baseflow_dry$cluster)
plot(x7, CP_Baseflow_dry$cluster,
     main="ECP test annual dry baseflow",
     xlab = "Year",
     ylab="cluster",
     type="p",
     col="blue")
dev.off()

########################################## orginal MK test for Baseflow_dry_annuall
TR_dry_baseflow<-rkt(Baseflow_dry_annuall$yearfraction,Baseflow_dry_annuall$sum_baseflow)
print(TR_dry_baseflow)
capture.output(summary(print(TR_dry_baseflow)), file = " Baseflow_annual_dry MK test results.txt")
TR_dry_baseflow$B
b0<- median(Baseflow_dry_annuall$sum_baseflow)-(TR_dry_baseflow$B * median(Baseflow_dry_annuall$Year))
Baseflow_dry_annuall$overall_slope<- b0+(TR_dry_baseflow$B * Baseflow_dry_annuall$Year)
length(Baseflow_dry_annuall$Year)
a2<-as.character(Baseflow_dry_annuall$Year[1]) 
b2<-as.character(Baseflow_dry_annuall$Year[length(Baseflow_dry_annuall$Year)]) 
z2<-as.character(lapply(TR_dry_baseflow$B, round,2))
Baseflow_dry_annuall$`Sens Slope`<- paste("a)",a2,"-",b2,":"," ",z2," ","GL/yr",sep='')
################################################## MKLTP
Baseflow_dry_annuall$MKLTP.Sig<-as.numeric (NA)
Baseflow_dry_annuall$Mean<-as.numeric (NA)
Baseflow_dry_annuall$Line<-as.numeric (NA)
Baseflow_dry_annuall$overll_line<-as.numeric (Baseflow_dry_annuall$overall_slope)
Baseflow_dry_annuall$Line.pvalue<-as.character(NA)
Baseflow_dry_annuall$Mid_date<-as.Date.numeric(NA)
Baseflow_dry_annuall$mLine<- as.numeric (NA)
#######################
myts_Dry<- ts(Baseflow_dry_annuall$sum_baseflow, start=c(min(Baseflow_dry_annuall$Year)),
              end=c(max(Baseflow_dry_annuall$Year)), frequency=1)
MKLTP_Dry_Baseflow<- MannKendallLTP(myts_Dry)
capture.output(summary(print(MKLTP_Dry_Baseflow)), file = " MKLTP annual Baseflow_Dry.txt")
Baseflow_dry_annuall$MKLTP.Sig<- if (MKLTP_Dry_Baseflow$Mann_Kendall_LTP[2]>0.01){
  paste(lapply(MKLTP_Dry_Baseflow$Mann_Kendall_LTP[2], round,2))} else {0.001}
Baseflow_dry_annuall$Line.pvalue<-if (Baseflow_dry_annuall$MKLTP.Sig<=0.05){paste("MKLTP", " ","p","(",Baseflow_dry_annuall$MKLTP.Sig,")", sep = "")} else{NA}
Baseflow_dry_annuall$Mid_date<-min(Baseflow_dry_annuall$date)
############################
Baseflow_dry_annuall$Seq<-as.numeric(CP_Baseflow_dry$cluster) 
ddddddddd<-as.numeric( which(CP_Baseflow_dry$cluster == max(CP_Baseflow_dry$cluster)))
Baseflow_dry_annuall$Seq[max(ddddddddd)+1]
jj<-max(ddddddddd)
JJJ<-as.numeric( length(Baseflow_dry_annuall$Seq))
Baseflow_dry_annuall$Seq[max(ddddddddd)+1]
i=Baseflow_dry_annuall$Seq[max(ddddddddd)+1]
Baseflow_dry_annuall$Seq[jj:JJJ]<- 
  if(i < as.numeric(Baseflow_dry_annuall$Seq[max(ddddddddd)])) {as.numeric(max(CP_Baseflow_dry$cluster)+1)} else{Baseflow_dry_annuall$Seq}
###view(Baseflow_dry_annuall)
Baseflow_dry_annuall$Max_date<- as.Date.numeric(NA) 
Baseflow_dry_annuall$ECP<-as.character(NA) 
Baseflow_dry_annuall$Seq_p.value<-as.numeric (NA)
Baseflow_dry_annuall$MKLTP_p.value<-as.numeric (NA)
max(Baseflow_dry_annuall$Seq)
#################
#for (i in Baseflow_dry_annuall$Seq){  
# m<- assign(paste("segment_wet", i, sep = "_"),subset(Baseflow_dry_annuall, Seq==i))}
######################################
Max_Seq_dry<-max(Baseflow_dry_annuall$Seq)
SSSSS<-plyr::ddply(Baseflow_dry_annuall, plyr::.(Seq), function(m){
  FD<-rkt(m$yearfraction,m$sum_baseflow)
  b0<- median(m$sum_baseflow)-(FD$B* median(m$Year))
  m$overall_slope<- b0+(FD$B*m$Year)
  length(m$Year)
  a3<-as.character(m$Year[1]) 
  b3<-as.character(m$Year[length(m$Year)]) 
  z3<-as.character(lapply(FD$B, round,2))
  m$`Sens Slope`<- paste( (if (m$Seq==1){"b)"} else if (m$Seq==2){"c)"} else if (m$Seq==3){"d)"} else if (m$Seq==4){"e)"} else if  (m$Seq==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","GL/yr",sep='')
  m$Max_date<- if (m$Seq< Max_Seq_dry){as.Date(max(m$date))} else {as.Date.numeric(NA)}
  m$ECP<- if (m$Seq< Max_Seq_dry){paste("ECP", m$Seq, sep = "")} else {as.character (NA)}
  m$Seq_p.value<- paste(lapply(FD$sl, round,2))
  #############
  myts_Wet <- ts(m$sum_baseflow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
  MKLTP_Dry_Baseflow<- MannKendallLTP(myts_Wet)
  m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Dry_Baseflow$Mann_Kendall_LTP[2], round,2),")", sep = "")
  ############################
  m$Mid_date<- min(m$date)
  m$Mean<-as.numeric (mean(m$sum_baseflow))
  m$MKLTP.Sig<- if (MKLTP_Dry_Baseflow$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Dry_Baseflow$Mann_Kendall_LTP[2], round,2))} else {0.001}
  m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
  m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
  m$overll_line<-as.numeric (NA)
  m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
  #################
  print(m$ECP)
  return(m)
}
)
##view(SSSSS)
#########
###############################
total_baseflow_dry<- rbind(Baseflow_dry_annuall,SSSSS)
##view(total_baseflow_wet)
tiff(paste0(" Annual baseflow dry_trend_change point ",".tiff"),width=2000, height=1500, res = 350)
Dry_baseflowtrend1<-ggplot(total_baseflow_dry, aes(x=date, color=`Sens Slope`))+
  geom_point(aes(y=sum_baseflow , color=`Sens Slope`),size=1)+
  ggtitle("Dry Seasons Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+
  xlab("Date")+ylab("Baseflow (GL/year)")
Dry_baseflowtrend2<-Dry_baseflowtrend1+geom_line(aes(y=overll_line),size=0.8,
                                                 linetype= if(total_baseflow_dry$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )
Dry_baseflowtrend3<-Dry_baseflowtrend2+geom_line(aes(y=Line),size=0.8,linetype="twodash")
Dry_baseflowtrend4<-Dry_baseflowtrend3+geom_line(aes(y=mLine),size=0.8,
                                                 linetype= if(total_baseflow_dry$MKLTP.Sig<= 0.05){"twodash"} else {"solid"})                                         

#################
for (i in total_baseflow_dry$Max_date){
  Dry_baseflowtrend4  <- Dry_baseflowtrend4+ 
    geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
}

Dry_baseflowtrend4<-Dry_baseflowtrend4+geom_text(mapping = aes(x = Max_date,
                                                               y = max(sum_baseflow ),
                                                               label = ECP,
                                                               hjust = 1.5,
                                                               vjust = 1.5),
                                                 size=2.5,
                                                 angle=90,
                                                 show.legend = FALSE,
                                                 data = total_baseflow_dry)

Dry_baseflowtrend4<-Dry_baseflowtrend4+geom_text(mapping = aes(x=Mid_date,
                                                               y = max(sum_baseflow ),
                                                               fill=`Sens Slope`,
                                                               label = Line.pvalue,
                                                               hjust = 1,
                                                               vjust = 3),
                                                 size=2.5,
                                                 angle=90,
                                                 show.legend = FALSE,
                                                 data = total_baseflow_dry)

Dry_baseflowtrend4
dev.off()
#################
################### A divisive hierarchical estimation algorithm for multiple change point analysis
################### e.divisive ENERGY DIVISIVE for annuall data
Baseflow_Dry
for(i in 1:5){
  ED_Dry_baseflow=e.divisive(X=Baseflow_Dry,sig.lvl=0.05,R=199,k=NULL,min.size=10,alpha=1)
  if(ED_Dry_baseflow$p.values[1]<=0.05) {
    print("End of Loop") ;
    break
  } else{ print("KHHHH")}
  
}

if (max(ED_Dry_baseflow$cluster)<2){capture.output(print("No change point"), file = " EDP No Change point for wet season baseflow.txt")} else{
  baseflow_ED_Dry<-Baseflow_dry_annuall %>% dplyr::select(1:8)
  baseflow_ED_Dry$Seq_ED<-as.numeric(ED_Dry_baseflow$cluster) 
  ########################################
  ##view( baseflow_ED_Dry)
  ################################################## MKLTP
  baseflow_ED_Dry$MKLTP.Sig<-as.numeric (NA)
  baseflow_ED_Dry$Mean<-as.numeric (NA)
  baseflow_ED_Dry$Line<-as.numeric (NA)
  baseflow_ED_Dry$overll_line<-as.numeric ( baseflow_ED_Dry$overall_slope)
  baseflow_ED_Dry$Line.pvalue<-as.character(NA)
  baseflow_ED_Dry$mLine<- as.numeric (NA)
  ########################
  baseflow_ED_Dry$Max_date_ED<- as.Date.numeric(NA) 
  baseflow_ED_Dry$EDP<-as.character(NA) 
  baseflow_ED_Dry$p.value<-as.numeric (NA)
  baseflow_ED_Dry$Seq_p.value<-as.numeric (NA)
  baseflow_ED_Dry$MKLTP_p.value<-as.numeric (NA)
  baseflow_ED_Dry$Mid_date_ED<-as.Date.numeric(NA)
  ###################################
  myts_Dry_ED<- ts(baseflow_ED_Dry$sum_baseflow, start=c(min( baseflow_ED_Dry$Year)), end=c(max( baseflow_ED_Dry$Year)), frequency=1)
  MKLTP_Dry_Baseflow_ED<- MannKendallLTP(myts_Dry_ED)
  capture.output(summary(print(MKLTP_Dry_Baseflow_ED)), file = " MKLTP annual Baseflow_Dry_ED.txt")
  baseflow_ED_Dry$MKLTP.Sig<- if (MKLTP_Dry_Baseflow_ED$Mann_Kendall_LTP[2]>0.01){
    paste(lapply(MKLTP_Dry_Baseflow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
  baseflow_ED_Dry$Line.pvalue<-if ( baseflow_ED_Dry$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(", baseflow_ED_Dry$MKLTP.Sig,")", sep = "")} else{NA}
  baseflow_ED_Dry$Mid_date_ED<-min( baseflow_ED_Dry$date)
  ############################
  ###########################
  ddddddddd<-as.numeric( which(ED_Dry_baseflow$cluster == max(ED_Dry_baseflow$cluster)))
  baseflow_ED_Dry$Seq_ED[max(ddddddddd)+1]
  jj<-max(ddddddddd)
  JJJ<-as.numeric( length( baseflow_ED_Dry$Seq_ED))
  baseflow_ED_Dry$Seq_ED[max(ddddddddd)+1]
  i= baseflow_ED_Dry$Seq_ED[max(ddddddddd)+1]
  #################
  #for (i in  baseflow_ED_Dry$Seq){  
  # m<- assign(paste("segment_", i, sep = "_"),subset( baseflow_ED_Dry, Seq==i))}
  ######################################
  Max_Seq_ED_Dry<-max( baseflow_ED_Dry$Seq_ED)
  EDPP1<-plyr::ddply(baseflow_ED_Dry, plyr::.(Seq_ED), function(m){
    FD<-rkt(m$yearfraction,m$sum_baseflow)
    b0<- median(m$sum_baseflow)-(FD$B* median(m$Year))
    m$overall_slope<- b0+(FD$B*m$Year)
    length(m$Year)
    a3<-as.character(m$Year[1]) 
    b3<-as.character(m$Year[length(m$Year)]) 
    z3<-as.character(lapply(FD$B, round,2))
    m$`Sens Slope`<- paste( (if (m$Seq_ED==1){"b)"} else if (m$Seq_ED==2){"c)"} else if (m$Seq_ED==3){"d)"} else if (m$Seq_ED==4){"e)"} else if  (m$Seq_ED==5){"f)"} else {"g)"}) ,a3,"-",b3,":"," ",z3," ","GL/yr",sep='')
    m$Max_date_ED<- if (m$Seq_ED< Max_Seq_ED_Dry){as.Date(max(m$date))} else {as.Date.numeric(NA)}
    m$p.value<- ED_Wet$p.values[m$Seq_ED]
    m$EDP<- if (m$Seq_ED< Max_Seq_ED_Dry){paste("EDP", m$Seq_ED," ","p","(",m$p.value,")", sep = "")} else {as.character (NA)}
    m$Seq_p.value<- paste(lapply(FD$sl, round,2))
    ######
    myts_Dry_ED <- ts(m$sum_baseflow, start=c(min(m$Year)), end=c(max(m$Year)), frequency=1)
    MKLTP_Dry_Baseflow_ED<- MannKendallLTP(myts_Dry_ED)
    m$MKLTP_p.value<- paste("MKLTP", " ","p","(",lapply(MKLTP_Dry_Baseflow_ED$Mann_Kendall_LTP[2], round,2),")", sep = "")
    ########################
    m$Mid_date_ED<- min(m$date)
    m$Mean<-as.numeric (mean(m$sum_baseflow))
    m$MKLTP.Sig<- if (MKLTP_Dry_Baseflow_ED$Mann_Kendall_LTP[2]>0.01){
      paste(lapply(MKLTP_Dry_Baseflow_ED$Mann_Kendall_LTP[2], round,2))} else {0.001}
    m$Line<- if(m$MKLTP.Sig<=0.05){NA} else{m$Mean}
    m$mLine<- as.numeric (if(m$MKLTP.Sig<=0.05){m$overall_slope} else{NA})
    m$overll_line<-as.numeric (NA)
    m$Line.pvalue<- as.character(if (m$MKLTP.Sig<=0.05) {paste("MKLTP", " ","p","(",m$MKLTP.Sig,")", sep = "")} else{NA})
    #################
    return(m)
  }
  )
  
  #####################################################################################
  total_baseflow_dry_EDP <- rbind( baseflow_ED_Dry,EDPP1)
  ####
  tiff(paste0(" Dry baseflow_trend_EDP change point ",".tiff"),width=2000, height=1500, res = 350)
  Dry_baseflowtrend_EDP1<-ggplot(total_baseflow_dry_EDP, aes(x=date, color=`Sens Slope`))+
    geom_point(aes(y=sum_baseflow, color=`Sens Slope`),size=1)+xlab("Date")+ylab("Baseflow (GL/yr)")+
    ggtitle("Dry Season Trend")+theme_bw()+theme(plot.title = element_text(hjust =0.5 ))
  Dry_baseflowtrend_EDP2<-Dry_baseflowtrend_EDP1+geom_line(aes(y=overll_line),size=0.8,
                                                           linetype= if(total_baseflow_dry_EDP$MKLTP.Sig<= 0.05){"solid"} else {"twodash"} )
  Dry_baseflowtrend_EDP3<-Dry_baseflowtrend_EDP2+geom_line(aes(y=Line),size=0.8,linetype="twodash")
  Dry_baseflowtrend_EDP4<-Dry_baseflowtrend_EDP3+ geom_line(aes(y=mLine),size=0.8,
                                                            linetype= if(total_baseflow_dry_EDP$MKLTP.Sig<= 0.05){"twodash"} else {"solid"})                                         
  
  ##########
  
  for (i in total_baseflow_dry_EDP$Max_date_ED){
    Dry_baseflowtrend_EDP4  <- Dry_baseflowtrend_EDP4+ 
      geom_vline(aes_(xintercept =i),size = 0.7,color= "black",linetype="longdash")
  }
  
  Dry_baseflowtrend_EDP4<-Dry_baseflowtrend_EDP4+geom_text(mapping = aes(x = Max_date_ED,
                                                                         y = max(sum_baseflow),
                                                                         label = EDP,
                                                                         hjust = 1.5,
                                                                         vjust = 1.5),
                                                           size=3,
                                                           angle=90,
                                                           show.legend = FALSE,
                                                           data =total_baseflow_dry_EDP)
  
  Dry_baseflowtrend_EDP4<-Dry_baseflowtrend_EDP4+geom_text(mapping = aes(x = Mid_date_ED,
                                                                         y = max(sum_baseflow),
                                                                         label = Line.pvalue,
                                                                         hjust = 1,
                                                                         vjust = 5.5), 
                                                           size=2.5,  
                                                           angle=90,
                                                           show.legend = FALSE,
                                                           data =total_baseflow_dry_EDP)
  Dry_baseflowtrend_EDP4
  
}# end of if
dev.off()
#################
RDWB<- Baseflow_wet_annuall$sum_baseflow
RDWB<- as.data.frame(RDWB)
RDWB$Dry<- Baseflow_dry_annuall$sum_baseflow
RDWB$Wet<-RDWB$RDWB
RDWB$divided<-RDWB$Dry/RDW$Wet
RDWB$Comulative<- cumsum(RDWB$divided)
RDWB$Percent<- RDWB$divided*100
RDWB$Year<-Baseflow_wet_annuall$date  
###view(RDW)
RDWB1<-ggplot(RDWB)+geom_line(aes(x=Year,y=Percent),color="blue")+ xlab("Date")+ylab("Dry / Wet (%)")+
  geom_smooth(aes(x=Year,y=Percent), color="red")
RDWB2<-RDWB1+theme_bw()
RDWB2
dev.off()
###############################################################
#####################    disrtribution ANALYSIS
total_flow_annuall
total_flow_annuall$Period<- gsub(':.*', "", total_flow_annuall$`Sens Slope`)
###
A1<-ggplot(total_flow_annuall, aes(sum_flow, fill=Period, color=Period))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Annuall Flow")+ylab("Density")
A1
#######total_flow_wet
total_flow_wet
total_flow_wet$Period<- gsub(':.*', "", total_flow_wet$`Sens Slope`)
A2<-ggplot(total_flow_wet, aes(sum_flow, fill=Period, color=Period ))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Wet Flow")+ylab("Density")
A2
############### 
total_flow_dry
total_flow_dry$Period<- gsub(':.*', "", total_flow_dry$`Sens Slope`)
A3<- ggplot(total_flow_dry, aes(sum_flow, fill=Period, color=Period ))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Dry Flow")+ylab("Density")
A3
############
tiff(paste0(" Annual_wet_dry season flow Distribution for ECP ",".tiff"),width=2000, height=2500, res = 350)
p8<-ggarrange(A1,A3,A2, nrow =3, ncol =1, heights = c(10, 10,10),
              widths =c(0.5) )
dev.off()
#################
############### Annuall Flow EDP
total_flow_annuall_EDP
total_flow_annuall_EDP$Period<- gsub(':.*', "", total_flow_annuall_EDP$`Sens Slope`)
A4<- ggplot(total_flow_annuall_EDP, aes(sum_flow, fill=Period, color=Period ))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Annuall Flow")+ylab("Density")

tiff(paste0(" Annual Flow Distribution for EDP",".tiff"),width=2000, height=2500, res = 350)
p7<-ggarrange( annual_flowtrend_EDP4,A4, nrow =2, ncol =1, heights = c(30,30),
               widths =c(0.5) )
dev.off()

#########################Wet
total_flow_Wet_EDP
total_flow_Wet_EDP$Period<- gsub(':.*', "",total_flow_Wet_EDP$`Sens Slope`)
A5<- ggplot(total_flow_Wet_EDP, aes(sum_flow, fill=Period, color=Period))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Wet Flow")+ylab("Density")

tiff(paste0(" Wet Flow Distribution for EDP",".tiff"),width=2000, height=2500, res = 350)
p6<-ggarrange(Wet_flowtrend_EDP4,A5, nrow =2, ncol =1, heights = c(30,30),
              widths =c(0.5) )
dev.off()
###############################################
total_flow_Dry_EDP
total_flow_Dry_EDP$Period<- gsub(':.*', "",total_flow_Dry_EDP$`Sens Slope`)
A6<- ggplot(total_flow_Dry_EDP, aes(sum_flow, fill=Period, color=Period))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Dry Flow")+ylab("Density")

tiff(paste0(" Dry flow Distribution for EDP",".tiff"),width=2000, height=2500, res = 350)
g<-ggarrange(Dry_flowtrend_EDP4,A6, nrow =2, ncol =1, heights = c(30,30),
             widths =c(0.5) )
dev.off()
######################################## Baseflow
##################### ECP distribution
total_baseflow_annuall
total_baseflow_annuall$Period<- gsub(':.*', "", total_baseflow_annuall$`Sens Slope`)
A7<-ggplot(total_baseflow_annuall, aes(sum_baseflow, fill=Period, color=Period))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Annuall Baseflow")+ylab("Density")
A7
#######total_flow_wet
total_baseflow_wet
total_baseflow_wet$Period<- gsub(':.*', "", total_baseflow_wet$`Sens Slope`)
A8<-ggplot(total_baseflow_wet, aes(sum_baseflow, fill=Period, color=Period ))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Wet Baseflow")+ylab("Density")
A8
############### 
total_baseflow_dry
total_baseflow_dry$Period<- gsub(':.*', "", total_baseflow_dry$`Sens Slope`)
A9<- ggplot(total_baseflow_dry, aes(sum_baseflow, fill=Period, color=Period ))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Dry Baseflow")+ylab("Density")
A9
############
tiff(paste0(" Annual_wet_dry season baseflow Distribution for ECP ",".tiff"),width=2000, height=2500, res = 350)
p5<-ggarrange(A7,A9,A8, nrow =3, ncol =1, heights = c(10, 10,10),
              widths =c(0.5) )
dev.off()
#################
############### Annuall Baseflow EDP
total_baseflow_annuall_EDP
total_baseflow_annuall_EDP$Period<- gsub(':.*', "", total_baseflow_annuall_EDP$`Sens Slope`)
A10<- ggplot(total_baseflow_annuall_EDP, aes(sum_baseflow, fill=Period, color=Period ))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Annuall Baseflow")+ylab("Density")

tiff(paste0(" Annual basefllow Distribution for EDP",".tiff"),width=2000, height=2500, res = 350)
p4<-ggarrange( annual_baseflowtrend_EDP4,A10, nrow =2, ncol =1, heights = c(30,30),
               widths =c(0.5) )
dev.off()

#########################Wet
total_baseflow_Wet_EDP
total_baseflow_Wet_EDP$Period<- gsub(':.*', "",total_baseflow_Wet_EDP$`Sens Slope`)
A11<- ggplot(total_baseflow_Wet_EDP, aes(sum_baseflow, fill=Period, color=Period))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Wet Baseflow")+ylab("Density")

tiff(paste0(" Wet Baseflow Distribution for EDP",".tiff"),width=2000, height=2500, res = 350)
p3<-ggarrange(Wet_baseflowtrend_EDP4,A11, nrow =2, ncol =1, heights = c(30,30),
              widths =c(0.5) )
dev.off()
###############################################
total_baseflow_dry_EDP
total_baseflow_dry_EDP$Period<- gsub(':.*', "",total_baseflow_dry_EDP$`Sens Slope`)
A12<- ggplot(total_baseflow_dry_EDP, aes(sum_baseflow, fill=Period, color=Period))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Dry Baseflow")+ylab("Density")

tiff(paste0(" Dry baseflow Distribution for EDP",".tiff"),width=2000, height=2500, res = 350)
p2<-ggarrange(Dry_baseflowtrend_EDP4,A12, nrow =2, ncol =1, heights = c(30,30),
              widths =c(0.5) )
dev.off()
####################### Zeor Flow Distribution
###### ECP
total_zeroflow_annuall$sum_zeroflow

total_zeroflow_annuall$Period<- gsub(':.*', "",total_zeroflow_annuall$`Sens Slope`)
A19<- ggplot(total_zeroflow_annuall, aes(sum_zeroflow, fill=Period, color=Period))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Zero Flow")+ylab("Density")

tiff(paste0(" Zero Flow Distribution for ECP",".tiff"),width=2000, height=2500, res = 350)
p19<-ggarrange(annual_zeroflowtrend4,A19, nrow =2, ncol =1, heights = c(30,30),
               widths =c(0.5) )
dev.off()


####EDP
total_zeroflow_annuall_EDP
total_zeroflow_annuall_EDP$Period<- gsub(':.*', "",total_zeroflow_annuall_EDP$`Sens Slope`)
A20<- ggplot(total_zeroflow_annuall_EDP, aes(sum_zeroflow, fill=Period, color=Period))+geom_density(alpha = 0.1)+
  theme_bw()+theme(plot.title = element_text(hjust =0.5 ))+xlab("Zero Flow")+ylab("Density")

tiff(paste0(" Zero Flow Distribution for EDP",".tiff"),width=2000, height=2500, res = 350)
p12<-ggarrange(annual_zeroflowtrend_EDP4,A20, nrow =2, ncol =1, heights = c(30,30),
               widths =c(0.5) )
dev.off()
###################### Overall Flow Trend
######################
tiff(paste0(" Overall Flow trend ",".tiff"),width=3000, height=3000, res = 300)
v<-ggarrange(Flowmonthly11,annual_flowtrend4,flow_dry4,Dry_flowtrend4,flow_wet4,Wet_flowtrend4,RDW2,annual_zeroflowtrend4, nrow =4, 
             ncol =2 ,labels = c("A", "E","B","F", "C","G","D","H"),
             heights = c(20,20,20,20),widths =c(10,10))
dev.off()

###
tiff(paste0(" Overall Flow trend 1 ",".tiff"),width=3000, height=3000, res = 300)
v1<-ggarrange(Flowmonthly11,annual_flowtrend4,flow_dry4,Dry_flowtrend4,flow_wet4,Wet_flowtrend4,RDW2, nrow =4, 
              ncol =2 ,labels = c("A", "E","B","F", "C","G","D"),
              heights = c(20,20,20,20),widths =c(10,10))
dev.off()
####
###################### Overall Baseflow Trend
tiff(paste0(" Overall Baseflow trend ",".tiff"),width=3000, height=3000, res = 300)
v2<-ggarrange(Time_Baseflow11,annualbaseflowtrend4,time_baseflowdry5,Dry_baseflowtrend4,time_baseflowwet5,Wet_baseflowtrend4,RDWB2,annual_zeroflowtrend_EDP4, nrow =4, 
              ncol =2 ,labels = c("A", "E","B","F", "C","G","D","H"),
              heights = c(20,20,20,20),widths =c(10,10))
dev.off()

########
tiff(paste0(" Overall Baseflow trend 1 ",".tiff"),width=3000, height=3000, res = 300)
v10<-ggarrange(Time_Baseflow11,annualbaseflowtrend4,time_baseflowdry5,Dry_baseflowtrend4,time_baseflowwet5,Wet_baseflowtrend4,RDWB2, nrow =4, 
               ncol =2 ,labels = c("A", "E","B","F", "C","G","D"),
               heights = c(20,20,20,20),widths =c(10,10))
dev.off()
############################
########################### Flow
tiff(paste0(" Annual_wet_dry flow and distribution season trend ",".tiff"),width=3500, height=3000, res = 350)
f2<-ggarrange(annual_flowtrend4,A1,Dry_flowtrend4,A3, Wet_flowtrend4,A2, 
              nrow =3, ncol =2,labels = c("A", "D", "B","E", "C","F"),
              heights = c(10, 10,10),widths =c(0.5,0.5) )
dev.off()

########################### baseflow

tiff(paste0(" Overall Baseflow Distribution for ECP ",".tiff"),width=3500, height=3000, res = 350)
v3<-ggarrange(annualbaseflowtrend4,A7,Dry_baseflowtrend4,A9,Wet_baseflowtrend4,A8,
              nrow =3, ncol =2 ,labels = c("A", "D", "B","E", "C","F"),
              heights = c(10,10,10),widths =c(0.5,0.5))
dev.off()
##########################

########################################
######################################## how to make nice table.

Pararmeters<- as.character( c("2-sided p-value", "Slope (GL/yr)", "Sig"))

`SMK Annuall`<-c(as.numeric(Tr_flow$sl),as.numeric(Tr_flow$B),if (Tr_flow$sl<= 0.01){"**"} 
                 else if (Tr_flow$sl<= 0.05){"*"} else{"-"})
`SMK Wet`<-c(as.numeric(TR_wet_flow$sl),as.numeric(TR_wet_flow$B),if (TR_wet_flow$sl<= 0.01){"**"} 
             else if (TR_wet_flow$sl<= 0.05){"*"} else{"-"})
`SMK Dry`<-c(as.numeric(Tr_flow_Dryseason$sl),as.numeric(Tr_flow_Dryseason$B),if (Tr_flow_Dryseason$sl<= 0.01){"**"} 
             else if (Tr_flow_Dryseason$sl<= 0.05){"*"} else{"-"})
##########################

`OMKT Annuall`<-c(as.numeric(TR_annual_flow$sl),as.numeric(TR_annual_flow$B),if (TR_annual_flow$sl<= 0.01){"**"} 
                  else if (TR_annual_flow$sl<= 0.05){"*"} else{"-"})
`OMKT Wet`<-c(as.numeric(TR_wet_flow$sl),as.numeric(TR_wet_flow$B),if (TR_wet_flow$sl<= 0.01){"**"} 
              else if (TR_wet_flow$sl<= 0.05){"*"} else{"-"})
`OMKT Dry`<-c(as.numeric(TR_dry_flow$sl),as.numeric(TR_dry_flow$B),if (TR_dry_flow$sl<= 0.01){"**"} 
              else if (TR_dry_flow$sl<= 0.05){"*"} else{"-"})
####################
`MKLTP Annuall`<-c(as.numeric(MKLTP_Annuall_Flow $Mann_Kendall_LTP[2]),as.numeric(MKLTP_Annuall_Flow$Mann_Kendall[4]),if (MKLTP_Annuall_Flow$Mann_Kendall_LTP[2]<= 0.01){"**"} 
                   else if (MKLTP_Annuall_Flow$Mann_Kendall_LTP[2]<= 0.05){"*"} else{"-"})
`MKLTP Wet`<-c(as.numeric(MKLTP_Wet_Flow$Mann_Kendall_LTP[2]),as.numeric(MKLTP_Wet_Flow$Mann_Kendall[4]),if (MKLTP_Wet_Flow$Mann_Kendall_LTP[2]<= 0.01){"**"} 
               else if (MKLTP_Wet_Flow$Mann_Kendall_LTP[2]<= 0.05){"*"} else{"-"})
`MKLTP Dry`<-c(as.numeric(MKLTP_Dry_Flow$Mann_Kendall_LTP[2]), as.numeric(MKLTP_Dry_Flow$Mann_Kendall[4]),if (MKLTP_Dry_Flow$Mann_Kendall_LTP[2]<= 0.01){"**"} 
               else if (MKLTP_Dry_Flow$Mann_Kendall_LTP[2]<= 0.05){"*"} else{"-"})
####################### Cerating Table
Table<- data.frame(Pararmeters,`SMK Annuall`, `SMK Wet`,`SMK Dry`,`OMKT Annuall`,`OMKT Wet`,`OMKT Dry`,
                   `MKLTP Annuall`,`MKLTP Wet`,`MKLTP Dry`)
#######################################
MKLT
Table[] <- lapply(Table, function(x) {
  x1 <- type.convert(as.character(x), as.is=TRUE)
  ifelse(grepl("^[0-9.-]+$", x1), round(as.numeric(x1), 3), x1)})

Table1<- formattable(Table,list(
  Pararmeters= formatter("span", 
                         style = ~ style(color = "red",font.weight = "bold"))))

saveWidget(as.htmlwidget(Table1), file ="Overall Statistics Table for Flow.html")
###################################
################################### Base flow 
Pararmeters<- as.character( c("2-sided p-value", "Slope (GL/yr)", "Sig"))
Tr_baseflow
Tr_Baseflow_Dryseason
Tr_Baseflow_Wetseason
`SMK Annuall`<-c(as.numeric( Tr_baseflow$sl),as.numeric( Tr_baseflow$B),if ( Tr_baseflow$sl<= 0.01){"**"} 
                 else if ( Tr_baseflow$sl<= 0.05){"*"} else{"-"})
`SMK Wet`<-c(as.numeric(Tr_Baseflow_Wetseason$sl),as.numeric(Tr_Baseflow_Wetseason$B),if (Tr_Baseflow_Wetseason$sl<= 0.01){"**"} 
             else if (Tr_Baseflow_Wetseason$sl<= 0.05){"*"} else{"-"})
`SMK Dry`<-c(as.numeric(Tr_Baseflow_Dryseason$sl),as.numeric(Tr_Baseflow_Dryseason$B),if (Tr_Baseflow_Dryseason$sl<= 0.01){"**"} 
             else if (Tr_Baseflow_Dryseason$sl<= 0.05){"*"} else{"-"})
##########################
TR_annual_baseflow
TR_wet_baseflow
TR_dry_baseflow
`OMKT Annuall`<-c(as.numeric(TR_annual_baseflow$sl),as.numeric(TR_annual_baseflow$B),if (TR_annual_baseflow$sl<= 0.01){"**"} 
                  else if (TR_annual_baseflow$sl<= 0.05){"*"} else{"-"})
`OMKT Wet`<-c(as.numeric(TR_wet_baseflow$sl),as.numeric(TR_wet_baseflow$B),if (TR_wet_baseflow$sl<= 0.01){"**"} 
              else if (TR_wet_baseflow$sl<= 0.05){"*"} else{"-"})
`OMKT Dry`<-c(as.numeric(TR_dry_baseflow$sl),as.numeric(TR_dry_baseflow$B),if (TR_dry_baseflow$sl<= 0.01){"**"} 
              else if (TR_dry_baseflow$sl<= 0.05){"*"} else{"-"})
####################
MKLT
`MKLTP Annuall`<-c(as.numeric(MKLTP_Annuall_Baseflow$Mann_Kendall_LTP[2]),as.numeric(MKLTP_Annuall_Baseflow$Mann_Kendall[4]),if (MKLTP_Annuall_Baseflow$Mann_Kendall_LTP[2]<= 0.01){"**"} 
                   else if (MKLTP_Annuall_Baseflow$Mann_Kendall_LTP[2]<= 0.05){"*"} else{"-"})
`MKLTP Wet`<-c(as.numeric(MKLTP_Wet_Baseflow$Mann_Kendall_LTP[2]),as.numeric(MKLTP_Wet_Baseflow$Mann_Kendall[4]),if (MKLTP_Wet_Baseflow$Mann_Kendall_LTP[2]<= 0.01){"**"} 
               else if (MKLTP_Wet_Baseflow$Mann_Kendall_LTP[2]<= 0.05){"*"} else{"-"})
`MKLTP Dry`<-c(as.numeric(MKLTP_Dry_Baseflow$Mann_Kendall_LTP[2]), as.numeric(MKLTP_Dry_Baseflow$Mann_Kendall[4]),if (MKLTP_Dry_Baseflow$Mann_Kendall_LTP[2]<= 0.01){"**"} 
               else if (MKLTP_Dry_Baseflow$Mann_Kendall_LTP[2]<= 0.05){"*"} else{"-"})
####################### Cerating Table
Table3<- data.frame(Pararmeters,`SMK Annuall`, `SMK Wet`,`SMK Dry`,`OMKT Annuall`,`OMKT Wet`,`OMKT Dry`,
                    `MKLTP Annuall`,`MKLTP Wet`,`MKLTP Dry`)
#######################################

Table3[] <- lapply(Table3, function(x) {
  x1 <- type.convert(as.character(x), as.is=TRUE)
  ifelse(grepl("^[0-9.-]+$", x1), round(as.numeric(x1), 3), x1)})

Table4<- formattable(Table3,list(
  Pararmeters= formatter("span", 
                         style = ~ style(color = "red",font.weight = "bold"))))

saveWidget(as.htmlwidget(Table4), file ="Overall Statistics Table for baseflow.html")
###################################
dev.off()
rm(list=ls())
